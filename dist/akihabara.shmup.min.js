!function(a){"use strict";var b={linear:function(a){return a},swing:function(a){return(1-Math.cos(a*Math.PI))/2},easeInQuad:function(a){return a*a},easeOutQuad:function(a){return a*(2-a)},easeInOutQuad:function(a){return.5>a?2*a*a:-1+(4-2*a)*a},easeInCubic:function(a){return a*a*a},easeOutCubic:function(a){return--a*a*a+1},easeInOutCubic:function(a){return.5>a?4*a*a*a:(a-1)*(2*a-2)*(2*a-2)+1},easeInQuart:function(a){return a*a*a*a},easeOutQuart:function(a){return 1- --a*a*a*a},easeInOutQuart:function(a){return.5>a?8*a*a*a*a:1-8*--a*a*a*a},easeInQuint:function(a){return a*a*a*a*a},easeOutQuint:function(a){return 1+--a*a*a*a*a},easeInOutQuint:function(a){return.5>a?16*a*a*a*a*a:1+16*--a*a*a*a*a}};a.Easing=b}(window),function(a){"use strict";var b=function(a,b,c,d,e){function f(){var a=new Date-j,k=i*e(a/h)+b;return a>h?(d(c),cancelAnimationFrame(g),g=null,!1):(d(k),void(g=requestAnimationFrame(f)))}e=e||function(a){return a};var g,h=a||1e3,i=c-b,j=new Date;f()};a.Tween=b}(window),function(a){"use strict";var b=function(){return this.init.apply(this,arguments)};b.prototype={constructor:b,STATE_STOPPED:0,STATE_STOPPING:1,STATE_PAUSED:2,STATE_PLAYING:3,_rHashQuery:/[#|?].*$/g,init:function(){this._channels={},this._audio={},this._video={},this._audioPaused=!1,this._supported={},this._supported.audio=this._getAudioSupport(),this._supported.video=this._getVideoSupport()},createAudioContext:function(){var b;return a.AudioContext?b=b:a.webkitAudioContext&&(b=webkitAudioContext),b?new b:b},createGainNode:function(a){var b;return b=a.createGain?a.createGain():a.createGainNode()},loadMedia:function(a,b){var c=new XMLHttpRequest,d=this;c.open("GET",a,!0),c.onreadystatechange=function(){if(4===this.readyState&&200===this.status){var a;try{a=JSON.parse(this.responseText)}catch(c){}a&&d.addMedia(a,b)}},c.send()},addMedia:function(a,b){var c=0,d=0,e=function(){c++,"function"==typeof b&&c===d&&b()};for(var f in a){d+=a[f].length;for(var g=a[f].length;g--;)this[f](a[f][g],e)}},addVideo:function(a,b){var c=this,d=a[0],e=new XMLHttpRequest;this._channels[a[2].channel]||(this._channels[a[2].channel]={}),this._video[d]={},this._video[d].channel=a[2].channel,this._video[d].loop=a[2].loop||!1,this._video[d].sources=a[1],this._video[d].element=document.createElement("video"),this._video[d].element.setAttribute("controls",!1),this._video[d]._usedSource=this._getUsedMediaSource("video",this._video[d].sources),this._video[d]._events={},e.open("GET",this._video[d]._usedSource.source,!0),e.onload=function(){var a=document.createElement("source");a.src=c._video[d]._usedSource.source,a.type=c._getMimeFromMedia(c._video[d]._usedSource.source),c._video[d].element.appendChild(a),"function"==typeof b&&b()},e.send()},addVideoEvent:function(a,b,c){this._video[a]&&(this._video[a]._events[b]=function(){"function"==typeof c&&c.apply(this,arguments)},this._video[a].element.addEventListener(b,this._video[a]._events[b],!1))},removeVideoEvent:function(a,b){this._video[a]&&(this._video[a].element.removeEventListener(b,this._video[a]._events[b],!1),this._video[a]._events[b]=null)},getVideo:function(a){var b;return this._video[a]&&(b=this._video[a].element),b},playVideo:function(a){this._video[a]&&(this._video[a].element.volume=this._channels[this._video[a].channel].volume,this._video[a].element.play())},stopVideo:function(a){this._video[a]&&this._video[a].element.pause()},addAudio:function(a,b){var c=this,d=a[0],e=new XMLHttpRequest;this._channels[a[2].channel]||(this._channels[a[2].channel]={}),this._audio[d]={},this._audio[d].channel=a[2].channel,this._audio[d].loop=a[2].loop||!1,this._audio[d].sources=a[1],this._audio[d].context=this.createAudioContext(),this._audio[d]._usedSource=this._getUsedMediaSource("audio",this._audio[d].sources),this._audio[d].state=this.STATE_STOPPED,e.open("GET",this._audio[d]._usedSource.source,!0),e.responseType="arraybuffer",e.onload=function(){c._audio[d].context.decodeAudioData(e.response,function(a){c._audio[d].startTime=0,c._audio[d].startOffset=0,c._audio[d].buffer=a,c._audio[d].gainNode=c.createGainNode(c._audio[d].context),"function"==typeof b&&b()})},e.send()},playAudio:function(a){this._audio[a]&&(this._audio[a].startTime=this._audio[a].context.currentTime,this._audio[a].source=this._audio[a].context.createBufferSource(),this._audio[a].source.buffer=this._audio[a].buffer,this._audio[a].source.connect(this._audio[a].gainNode),this._audio[a].gainNode.connect(this._audio[a].context.destination),this._audio[a].gainNode.gain.value=this._channels[this._audio[a].channel].volume||1,this._audio[a].loop&&(this._audio[a].source.loop=!0),this._sourceStart(this._audio[a]),this._audio[a].state=this.STATE_PLAYING)},hitAudio:function(a){this.playAudio(a)},stopAudio:function(a){this._audio[a]&&(this._audio[a].startTime=0,this._audio[a].startOffset=0,this._audio[a].state=this.STATE_STOPPED,this._sourceStop(this._audio[a]))},pauseAudio:function(a){this._audio[a]&&(this._audio[a].startOffset+=this._audio[a].context.currentTime-this._audio[a].startTime,this._audio[a].state=this.STATE_PAUSED,this._sourceStop(this._audio[a]))},fadeAudioIn:function(a,b){if(this._audio[a].state===this.STATE_PLAYING)return this;var c=this,d=this._channels[this._audio[a].channel].volume;this._audio[a]&&(this._audio[a].state===this.STATE_STOPPED?(this._audio[a].gainNode.gain.value=0,this.playAudio(a)):this._audio[a].state===this.STATE_STOPPING&&(this._audio[a].state=this.STATE_PLAYING),new Tween(b||1e3,0,d,function(b){c._audio[a].gainNode.gain.value=b}))},fadeAudioOut:function(a,b){if(this._audio[a].state===this.STATE_STOPPING)return this;var c=this;this._audio[a]&&(this._audio[a].state=this.STATE_STOPPING,new Tween(b||1e3,this._audio[a].gainNode.gain.value,0,function(b){c._audio[a].state===c.STATE_STOPPING&&(c._audio[a].gainNode.gain.value=b,0===c._audio[a].gainNode.gain.value&&c.stopAudio(a))}))},stopChannel:function(a){for(var b in this._audio)this._audio[b].channel===a&&this._audio[b].state===this.STATE_PLAYING&&this.pauseAudio(b)},playChannel:function(a){for(var b in this._audio)this._audio[b].channel===a&&this._audio[b].state===this.STATE_PAUSED&&this.playAudio(b)},fadeChannelOut:function(a,b){for(var c in this._audio)this._audio[c].channel===a&&this._audio[c].state===this.STATE_PLAYING&&this.fadeAudioOut(c,b)},fadeChannelIn:function(a,b){for(var c in this._audio)this._audio[c].channel===a&&this._audio[c].state===this.STATE_PAUSED&&this.fadeAudioIn(c,b)},crossFadeChannel:function(a,b,c){for(var d in this._audio)this._audio[d].channel===a&&this._audio[d].state===this.STATE_PLAYING&&this.fadeAudioOut(d,c);this.fadeAudioIn(b,c)},setChannelVolume:function(a,b){this._channels[a]&&(this._channels[a].volume=b)},pauseAll:function(a){if(this._audioPaused)return this;this._audioPaused=!0;for(var b in this._audio)this._audio[b].state===this.STATE_PLAYING&&this._audio[b].channel===a&&this.pauseAudio(b)},resumeAll:function(a){if(!this._audioPaused)return this;this._audioPaused=!1;for(var b in this._audio)this._audio[b].state===this.STATE_PAUSED&&this._audio[b].channel===a&&this.playAudio(b)},_sourceStart:function(a){a.source.start?a.source.start(0,a.startOffset%a.buffer.duration):a.source.noteOn(0,a.startOffset%a.buffer.duration)},_sourceStop:function(a){a.source.stop?a.source.stop(0):a.source.noteOff(0)},_getMimeFromMedia:function(a){var b;switch(a.split(".").pop().toLowerCase()){case"ogg":b="audio/ogg";break;case"mp3":b="audio/mpeg";break;case"webm":b="video/webm";break;case"mp4":b="video/mp4";break;case"ogv":b="video/ogg"}return b},_getUsedMediaSource:function(a,b){for(var c,d,e=b.length;e--;){var f=b[e].split(".").pop().toLowerCase().replace(this._rHashQuery,"");if("video"===a&&"mp4"===f?"probably"===this._supported.video.mpeg4||"probably"===this._supported.video.h264?(c=b[e],d="probably"):("maybe"===this._supported.video.mpeg4||"maybe"===this._supported.video.h264)&&(c=b[e],d="maybe"):"probably"===this._supported[a][f]?(c=b[e],d="probably"):"maybe"===this._supported[a][f]&&(c=b[e],d="maybe"),c)break}return{source:c,canPlay:d}},_getAudioSupport:function(){var a=document.createElement("audio"),b=/^no$/,c={};try{a.canPlayType&&(c.ogg=a.canPlayType('audio/ogg; codecs="vorbis"').replace(b,""),c.mp3=a.canPlayType("audio/mpeg;").replace(b,""),c.wav=a.canPlayType('audio/wav; codecs="1"').replace(b,""),c.m4a=(a.canPlayType("audio/x-m4a;")||a.canPlayType("audio/aac;")).replace(b,""))}catch(d){}return c},_getVideoSupport:function(){var a=document.createElement("video"),b=/^no$/,c={};try{a.canPlayType&&(c.mpeg4=a.canPlayType('video/mp4; codecs="mp4v.20.8"').replace(b,""),c.ogg=a.canPlayType('video/ogg; codecs="theora"').replace(b,""),c.h264=a.canPlayType('video/mp4; codecs="avc1.42E01E"').replace(b,""),c.webm=a.canPlayType('video/webm; codecs="vp8, vorbis"').replace(b,""))}catch(d){}return c}},a.MediaBox=b}(window),function(a,b){"use strict";var c=a.localStorage,d=function(){return this.init.apply(this,arguments)};d.prototype={constructor:d,_storageKey:"_gamestate_",_rDashHyphAlphas:/(?:-|--|_|__)([\da-z])/gi,init:function(a){a=a||{},this._doSaveState=!0,this._state=this._loadState()||a,this._saveState()},_loadState:function(){var a;try{this._doSaveState&&(a=JSON.parse(c.getItem(this._storageKey)))}catch(b){}return a},_saveState:function(){try{this._doSaveState&&c.setItem(this._storageKey,JSON.stringify(this.getState()))}catch(a){}},camelCase:function(a){return a.replace(this._rDashHyphAlphas,function(a,b){return b.toUpperCase()})},getState:function(){return this._state},setState:function(){this._saveState()},pushState:function(a,c){for(var d in a)(this._state[d]===b||c)&&(this._state[d]=a[d]);this._saveState()},setValue:function(a,b){this._state[a]=b,this._saveState()},setValueDeep:function(a,b,c){this._state[a]&&(this._state[a][b]=c,this._saveState())},getValue:function(a){return this._state[a]},getValueDeep:function(a,b){return this._state[a]?this._state[a][b]:void 0}},a.GameState=d}(window),function(a){"use strict";var b=a.localStorage,c=function(){return this.init.apply(this,arguments)};c.prototype={constructor:c,_storageKey:"_gamequest_",init:function(a){a=a||{},this._doSaveQuests=!0,this._quests=this._loadQuests()||a,this._saveQuests()},_loadQuests:function(){var a;try{this._doSaveQuests&&(a=JSON.parse(b.getItem(this._storageKey)))}catch(c){}return a},_saveQuests:function(){try{this._doSaveQuests&&b.setItem(this._storageKey,JSON.stringify(this.getQuests()))}catch(a){}},getQuests:function(){return this._quests},setQuests:function(){this._saveQuests()},addQuest:function(a){return this._quests[a]?this:(this._quests[a]={complete:!1,parameters:{}},void this._saveQuests())},completeQuest:function(a){this._quests[a]&&(this._quests[a].complete=!0,this._saveQuests())},removeQuest:function(a){this._quests[a]&&(delete this._quests[a],this._saveQuests())},getQuest:function(a){return this._quests[a]},isQuestComplete:function(a){return this._quests[a]&&this._quests[a].complete}},a.GameQuest=c}(window),function(a,b){"use strict";var c=function(){return this.init.apply(this,arguments)};c.prototype={constructor:c,init:function(a){this._screens=a||{}},getScreen:function(a){return this._screens[a]},addScreen:function(a,b,c,d){for(var e=[],f=d||0,g=0;c>g;g++){e[g]=[];for(var h=0;b>h;h++)e[g][h]=f,f++}this.setScreen(a,e)},setScreen:function(a,b){this._screens[a]=b},getScreenValue:function(a,c){var d,e=this.getScreen(a);return e[c.y]!==b&&e[c.y][c.x]!==b&&(d=e[c.y][c.x]),d},getScreenPosition:function(a,b){for(var c,d=this.getScreen(a),e=d.length;e--;)for(var f=d[e].length;f--;)d[e][f]===b&&(c={x:f,y:e});return c}},a.GameScreen=c}(window),function(a){var b=function(){};b.prototype=new a,b.prototype.blitVideo=function(a,b,c,d,e,f,g){function h(){try{clearTimeout(i)}catch(k){}j._video[a].element.paused||j._video[a].element.ended?(i=null,"function"==typeof g&&g()):(b.drawImage(j._video[a].element,c,d,e,f),i=setTimeout(h,0))}if(!this._video[a])return this;var i=null,j=this;h()},window.AkihabaraMediabox=new b}(window.MediaBox),function(a){var b=function(){};b.prototype=new a,window.AkihabaraGamestate=new b}(window.GameState),function(a){var b=function(){};b.prototype=new a,window.AkihabaraGamequest=new b}(window.GameQuest),function(a){var b=function(){};b.prototype=new a,window.AkihabaraGamescreen=new b}(window.GameScreen);var Akihabara={VERSION:"2.0.0",extendsFrom:function(a,b){if(null==b&&(b={}),null!=a)for(var c in a)null==b[c]&&(b[c]=a[c]);return b},copyModel:function(a,b){if(null==a&&(a={}),null!=b)for(var c in b)a[c]=b[c];return a},createModel:function(a,b){for(var c={},d=0;d<b.length;d++)c[b[d]]=a[b[d]];return c},cloneObject:function(a){if(!a)return a;var b={};for(var c in a)b[c]=a[c];return b},createNewGame:function(a){"string"===(typeof a).toLowerCase()&&(a={title:a});var b=AkihabaraDevices.configurationFor(navigator.userAgent),c=["MADE WITH AKIHABARA (C)2012 - GPL2/MIT","Project: http://akihabara.github.com","Sources: http://github.com/akihabara"];if(document.title=a.title?a.title:"Akihabara",a.splash){if(a.splash.footnotes)for(var d=0;d<c.length;d++)a.splash.footnotes.push(c[d]);AkihabaraGamebox.setSplashSettings(a.splash)}var e=a.width?a.width:a.portrait?240:320,f=a.height?a.height:a.portrait?320:240;return b.iswii&&(AkihabaraInput._keymap={left:175,right:176,up:177,down:178,a:173,b:172,c:13},document.onkeypress=function(a){return a.preventDefault?(a.preventDefault(),!1):void 0}),"string"==typeof a.basepath&&AkihabaraGamebox.setBasePath(a.basepath),a.debugfont&&AkihabaraGamebox.setDebugFont(a.debugfont),a.offlinecache&&AkihabaraGamebox.setOfflineCache(a.offlinecache),a.splash&&null!=a.splash.minilogo||AkihabaraGamebox.setSplashSettings({minilogo:"logo"}),a.splash&&null!=a.splash.background||AkihabaraGamebox.setSplashSettings({background:AkihabaraGamebox._basepath+"splash.png"}),a.splash&&null!=a.splash.minimalTime||AkihabaraGamebox.setSplashSettings({minimalTime:3e3}),a.splash&&null!=a.splash.footnotes||AkihabaraGamebox.setSplashSettings({footnotes:c}),a&&a.hardwareonly||(document.body.style.backgroundColor="#000000",AkihabaraGamebox.setScreenBorder(!1)),a.backgroundColor&&(document.body.style.backgroundColor=a.backgroundColor),AkihabaraDebug&&AkihabaraDebug.applyURLParametersOn(b),a.zoom?AkihabaraGamebox.setZoom(a.zoom):b.zoom?AkihabaraGamebox.setZoom(b.zoom):b.width?AkihabaraGamebox.setZoom(b.width/e):b.height&&AkihabaraGamebox.setZoom(b.height/f),AkihabaraGamebox.setFps(a.fps?a.fps:25),b.forcedidle&&AkihabaraGamebox.setForcedIdle(b.forcedidle),a&&a.hardwareonly||AkihabaraGamebox.initScreen(e,f),b}},AkihabaraInput={_keyboard:[],_keyboardpicker:0,_keymap:{up:38,down:40,right:39,left:37,a:90,b:88,c:67,pause:80,mute:77},_keydown:function(a){a.preventDefault&&a.preventDefault();var b=a.fake||window.event?a.keyCode:a.which;AkihabaraInput._keyboard[b]||(AkihabaraInput._keyboard[b]=1)},_keyup:function(a){a.preventDefault&&a.preventDefault();var b=a.fake||window.event?a.keyCode:a.which;AkihabaraInput._keyboard[b]=-1,a.keyCode===AkihabaraInput._keymap.pause&&AkihabaraGamebox.pauseGame()},_resetkeys:function(){for(var a in AkihabaraInput._keymap)AkihabaraInput._keyup({fake:1,keyCode:AkihabaraInput._keymap[a]})},_showkeyboardpicker:function(){AkihabaraInput._keyboardpicker.value="Click/Tap here to enable the keyboard",AkihabaraInput._keyboardpicker.style.left=AkihabaraGamebox._screenposition.x+5+"px",AkihabaraInput._keyboardpicker.style.top=AkihabaraGamebox._screenposition.y+5+"px",AkihabaraInput._keyboardpicker.style.width=AkihabaraGamebox._screenposition.w-10+"px",AkihabaraInput._keyboardpicker.style.height="30px",AkihabaraInput._keyboardpicker.style.border="1px dashed white",AkihabaraInput._keyboardpicker.readOnly=null},_hidekeyboardpicker:function(){AkihabaraInput._keyboardpicker.style.zIndex=100,AkihabaraInput._keyboardpicker.readOnly="yes",AkihabaraInput._keyboardpicker.style.position="absolute",AkihabaraInput._keyboardpicker.style.textAlign="center",AkihabaraInput._keyboardpicker.style.backgroundColor="#000000",AkihabaraInput._keyboardpicker.style.color="#fefefe",AkihabaraInput._keyboardpicker.style.cursor="pointer",AkihabaraInput._keyboardpicker.value="",AkihabaraInput._keyboardpicker.style.left="0px",AkihabaraInput._keyboardpicker.style.top="0px",AkihabaraInput._keyboardpicker.style.height="0px",AkihabaraInput._keyboardpicker.style.width="0px",AkihabaraInput._keyboardpicker.style.border="0px",AkihabaraInput._keyboardpicker.style.padding="0px",AkihabaraInput._keyboardpicker.style.margin="0px"},keyIsHit:function(a){return 1===this._keyboard[this._keymap[a]]},keyIsPressed:function(a){return this._keyboard[this._keymap[a]]>0},keyIsHold:function(a){return this._keyboard[this._keymap[a]]>1},keyIsReleased:function(a){return-1===this._keyboard[this._keymap[a]]},addKeyListernerTo:function(a){a.addEventListener(window,"keydown",AkihabaraInput._keydown),a.addEventListener(window,"keyup",AkihabaraInput._keyup)},focusDrivenKeyboardSuport:function(a){AkihabaraInput._keyboardpicker=document.createElement("input"),AkihabaraInput._keyboardpicker.onclick=function(a){AkihabaraInput._hidekeyboardpicker(),a.preventDefault(),a.stopPropagation()},AkihabaraInput._hidekeyboardpicker(AkihabaraInput._keyboardpicker),a._box.appendChild(AkihabaraInput._keyboardpicker)},addTouchEventsTo:function(a){a.ontouchstart=function(a){AkihabaraGamebox._screenposition=AkihabaraGamebox._domgetabsposition(AkihabaraGamebox._screen),a.touches[0].pageY-AkihabaraGamebox._screenposition.y<30?AkihabaraInput._showkeyboardpicker():(AkihabaraInput._hidekeyboardpicker(),a.preventDefault(),a.stopPropagation())},a.onmousedown=function(a){AkihabaraGamebox._screenposition=AkihabaraGamebox._domgetabsposition(AkihabaraGamebox._screen),a.pageY-AkihabaraGamebox._screenposition.y<30?AkihabaraInput._showkeyboardpicker():(AkihabaraInput._hidekeyboardpicker(),a.preventDefault(),a.stopPropagation())},a.ontouchend=function(a){a.preventDefault(),a.stopPropagation()},a.ontouchmove=function(a){a.preventDefault(),a.stopPropagation()}}},AkihabaraDebug={objToStr:function(a){var b="";for(var c in a)b+=c+":["+a[c]+"] ";return b},framesToTime:function(a){var b=Math.ceil(a/AkihabaraGamebox.getFps()*100);return AkihabaraHelpers.prepad(Math.floor(b/6e3)%60,2,"0")+":"+AkihabaraHelpers.prepad(Math.floor(b/100)%60,2,"0")+":"+AkihabaraHelpers.prepad(b%100,2,"0")},fpsCounterInit:function(a){a||(a={}),a.x||(a.x=0),a.y||(a.y=0),a.font||(a.font="lighter 10px sans-serif"),a.color||(a.color="#FFF"),a.frameCount=0,a.currentFps=0,a.lastFps=(new Date).getTime(),this.addDebugAction("fpsCounter",a)},statusBar:function(a){a||(a={}),a.backgroundColor||(a.backgroundColor="#FFF"),a.color||(a.color="#000"),a.font||(a.font="lighter 10px sans-serif"),this.addDebugAction("statusBar",a)},setStatBar:function(a){function b(){if(!AkihabaraGamebox._debugTool.statusBar)return!1;var a=document.createElement("div");AkihabaraGamebox._border&&(a.style.border="1px solid black"),a.style.margin="auto",a.style.backgroundColor=AkihabaraGamebox._debugTool.statusBar.backgroundColor,a.style.font=AkihabaraGamebox._debugTool.statusBar.font,a.style.color=AkihabaraGamebox._debugTool.statusBar.color,a.style.width=AkihabaraGamebox._camera.w*AkihabaraGamebox._zoom+"px",AkihabaraGamebox._container.appendChild(a),AkihabaraGamebox._statbar=a}AkihabaraGamebox._statbar||b(),AkihabaraGamebox._statbar.innerHTML=a||"&nbsp"},addDebugAction:function(a,b){AkihabaraGamebox._debugTool[a]=b},run:function(a){if(a.fpsCounter){var b=a.fpsCounter,c=(new Date).getTime(),d=Math.ceil(c-b.lastFps),e=AkihabaraGamebox._screenCtx;d>=1e3&&(b.currentFps=b.frameCount,b.frameCount=0,b.lastFps=c),b.frameCount++,e.fillStyle=b.color,e.font=b.font,e.fillText("FPS: "+b.currentFps+"/"+AkihabaraGamebox._fps,b.x,b.y)}if(a.statusBar){var f="Idle: "+AkihabaraGamebox._framestart+"/"+AkihabaraGamebox._mspf+(AkihabaraGamebox._frameskip>0?" ("+AkihabaraGamebox._frameskip+"skip)":"")+" | ",g=0,h=0;for(h=0;h<AkihabaraGamebox._groups.length;h++)if(AkihabaraGamebox._groupplay[AkihabaraGamebox._groups[h]]){g=0;for(var i in AkihabaraGamebox._objects[AkihabaraGamebox._groups[h]])g++;g&&(f+=AkihabaraGamebox._groups[h]+"["+g+"] ")}AkihabaraGamebox._pauseGame&&(f+=" | PAUSE ON"),this.setStatBar(f)}},getURL:function(){return window.location.href},getURLValueFor:function(a){a=a.replace(/[\[]/,"[").replace(/[\]]/,"]");var b=new RegExp("[?&]"+a+"=([^&#]*)"),c=b.exec(AkihabaraDebug.getURL());return null==c?"":c[1]},applyURLParametersOn:function(a){AkihabaraDebug.getURLValueFor("statusbar")&&AkihabaraDebug.statusBar(),(AkihabaraDebug.getURLValueFor("db")||a.doublebuffering)&&AkihabaraGamebox.setDoubleBuffering(!0),AkihabaraDebug.getURLValueFor("noautoskip")&&AkihabaraGamebox.setAutoskip(null),AkihabaraDebug.getURLValueFor("zoom")&&AkihabaraGamebox.setZoom(AkihabaraDebug.getURLValueFor("zoom")),AkihabaraDebug.getURLValueFor("fps")&&AkihabaraGamebox.setFps(1*AkihabaraDebug.getURLValueFor("fps")),AkihabaraDebug.getURLValueFor("fskip")&&AkihabaraGamebox.setFrameskip(AkihabaraDebug.getURLValueFor("fskip")),AkihabaraDebug.getURLValueFor("forcedidle")&&AkihabaraGamebox.setForcedIdle(1*AkihabaraDebug.getURLValueFor("forcedidle")),AkihabaraDebug.getURLValueFor("canlog")&&AkihabaraGamebox.setCanLog(!0),AkihabaraDebug.getURLValueFor("showplayers")&&AkihabaraGamebox.setShowPlayers("yes"===AkihabaraDebug.getURLValueFor("showplayers"))}},AkihabaraTrigo={ANGLE_RIGHT:0,ANGLE_DOWN:.5*Math.PI,ANGLE_LEFT:Math.PI,ANGLE_UP:1.5555555*Math.PI,addAngle:function(a,b){return a=(a+b)%(2*Math.PI),0>a?2*Math.PI+a:a},getDistance:function(a,b){return Math.sqrt(Math.pow(b.x-a.x,2)+Math.pow(b.y-a.y,2))},getAngle:function(a,b,c){return AkihabaraTrigo.addAngle(Math.atan2(b.y-a.y,b.x-a.x),c?c:0)},translate:function(a,b,c){a.x=a.x+Math.cos(b)*c,a.y=a.y+Math.sin(b)*c},translateX:function(a,b,c){return a+Math.cos(b)*c},translateY:function(a,b,c){return a+Math.sin(b)*c}},AkihabaraDynalist={create:function(){return{test:null,first:null,last:null,data:[],dl:0,gar:[],disconnect:function(a){null!=this.data[a].__first?this.data[this.data[a].__first].__next=this.data[a].__next:this.first=this.data[a].__next,null!=this.data[a].__next?this.data[this.data[a].__next].__first=this.data[a].__first:this.last=this.data[a].__first},addObject:function(a,b){var c=this.gar.pop();if(null==c&&(c=this.dl,this.dl++),null==this.first)a.__next=null,a.__first=null,this.first=c,this.last=c;else{for(var d=this.first;null!=d&&!(this.data[d].__prio>b);)d=this.data[d].__next;null==d?(a.__next=null,a.__first=this.last,this.data[this.last].__next=c,this.last=c):(a.__first=this.data[d].__first,a.__next=d,this.data[d].__first=c,null!=a.__first?this.data[a.__first].__next=c:this.first=c)}return a.__prio=b,a.__id=c,this.data[c]=a,c},setPrio:function(a,b){var c;if(this.data[a].__prio!==b){if(this.first!==this.last)if(this.data[a].__prio<b){if(this.data[a].__id!==this.last){for(c=this.data[a].__next;null!=c&&!(this.data[c].__prio>=b);)c=this.data[c].__next;(null==c||this.data[c].__first!==this.data[a].__id)&&(this.disconnect(a),null==c?(this.data[this.last].__next=this.data[a].__id,this.data[a].__first=this.last,this.data[a].__next=null,this.last=this.data[a].__id):(this.data[a].__first=this.data[c].__first,this.data[a].__next=c,this.data[c].__first=this.data[a].__id,null!=this.data[a].__first?this.data[this.data[a].__first].__next=this.data[a].__id:this.first=this.data[a].__id))}}else if(this.data[a].__id!==this.first){for(c=this.data[a].__first;null!=c&&!(this.data[c].__prio<=b);)c=this.data[c].__first;(null==c||this.data[c].__next!==this.data[a].__id)&&(this.disconnect(a),null==c?(this.data[this.first].__first=this.data[a].__id,this.data[a].__first=null,this.data[a].__next=this.first,this.first=this.data[a].__id):(this.data[a].__first=c,this.data[a].__next=this.data[c].__next,this.data[c].__next=this.data[a].__id,null!=this.data[a].__next?this.data[this.data[a].__next].__first=this.data[a].__id:this.last=this.data[a].__id))}this.data[a].__prio=b}},remove:function(a){this.disconnect(a),this.gar.push(this.data[a].__id),delete this.data[this.data[a].__id]}}}},AkihabaraCyclelist={create:function(a){return{_head:0,_tail:0,_data:[],_size:a?a:10,_total:0,_done:0,_current:null,getTotal:function(){return this._total},getDone:function(){return this._done},getSize:function(){return this._size},isProcessing:function(){return null!=this._current},isEnded:function(){return this._head===this._tail},isBusy:function(){return this.isProcessing()||!this.isEnded()},getCurrent:function(){return this._current},push:function(a){this._data[this._head]=a,this._head=(this._head+1)%this._size,this._total++},pop:function(){return this.isEnded()?(this._total=0,this._done=0,this._current=null):(this._current=this._data[this._tail],this._tail=(this._tail+1)%this._size,this._done++),this._current},dump:function(){for(var a="",b=0;b<this._size;b++)a+=b+") "+this._data[b]+" | "+(b===this._head?"HEAD ":"")+(b===this._tail?"TAIL ":"")+"\n";return a+="\n\n"+this._done+"/"+this._total}}}},AkihabaraCachelist={create:function(a){return{_cache:{},_queue:[],_head:0,_size:a?a:10,add:function(a,b){this._cache[a]?this._cache[a].value=b:(this._queue[this._head]&&delete this._cache[this._queue[this._head]],this._queue[this._head]=a,this._cache[a]={pos:this._head,value:b},this._head=(this._head+1)%this._size)},read:function(a){return this._cache[a]?this._cache[a].value:null},clear:function(){this._cache={},this._queue=[],this._head=0}}}},AkihabaraGamebox={ALIGN_CENTER:0,ALIGN_MIDDLE:0,ALIGN_RIGHT:1,ALIGN_BOTTOM:1,COLOR_BLACK:"rgb(0, 0, 0)",COLOR_WHITE:"rgb(255, 255, 255)",ZINDEX_LAYER:-1,PALETTES:{c64:{order:["black","white","red","cyan","purple","green","blue","yellow","orange","brown","lightred","darkgray","gray","lightgreen","lightblue","lightgray"],colors:{black:"#000000",white:"#FFFFFF",red:"#68372B",cyan:"#70A4B2",purple:"#6F3D86",green:"#588D43",blue:"#352879",yellow:"#B8C76F",orange:"#6F4F25",brown:"#433900",lightred:"#9A6759",darkgray:"#444444",gray:"#6C6C6C",lightgreen:"#9AD284",lightblue:"#6C5EB5",lightgray:"#959595"}}},_pauseGame:!1,_debugTool:{},_basepath:"akihabara/images/",_autoid:0,_cb:null,_flagstype:{experimental:"check",fse:"list",offlinecache:"check",loadscreen:"list",noaudio:"check"},_flags:{experimental:!1,fse:"none",offlinecache:!1,loadscreen:"normal",noaudio:!1},_localflags:{},_fonts:{},_tiles:{},_images:{},_camera:{},_debugfont:"debugfont.png",getDebugFont:function(){return AkihabaraGamebox._basepath+AkihabaraGamebox._debugfont},_container:"",_screen:0,_screenCtx:null,_screenposition:0,_screenh:0,_screenw:0,_screenhh:0,_screenhw:0,_zoom:1,_canvas:{},_objects:{},_groups:[],_renderorder:[],_groupplay:{},_actionqueue:["first","then","blit","after"],_mspf:0,_fps:0,_gametimer:0,_frameskip:0,_autoskip:{min:0,max:5,lowidle:0,hiidle:5},_fskid:0,_statbar:"",_border:0,_garbage:[],_zindexch:[],_framestart:0,_zindex:AkihabaraDynalist.create(),_db:!1,_sessioncache:"",_breakcacheurl:function(a){return this._flags.offlinecache?a:a+(-1===a.indexOf("?")?"?":"&")+"_brc="+AkihabaraGamebox._sessioncache},_forcedidle:0,_gamewaiting:0,_canlog:!1,_splash:{gaugeLittleColor:"rgb(255, 240, 0)",gaugeLittleBackColor:"rgb(255, 255, 255)",gaugeBorderColor:"rgb(0, 0, 0)",gaugeBackColor:"rgb(100, 100, 100)",gaugeColor:"rgb(255, 240, 0)",gaugeHeight:10,background:null,minimalTime:0,footnotes:null,footnotesSpacing:1},_minimalexpired:0,setCanLog:function(a){this._canlog=a&&window.console},canLog:function(){return this._canlog},log:function(){},_safedrawimage:function(a,b,c,d,e,f,g,h,i,j){if(b&&a){0>c&&(g-=i/e*c,e+=c,c=0),0>d&&(h-=j/f*d,f+=d,d=0),c+e>b.width&&(i=i/e*(b.width-c),e=b.width-c),d+f>b.height&&(j=j/f*(b.height-d),f=b.height-d);try{f>0&&e>0&&c<b.width&&d<b.height&&a.drawImage(b,c,d,e,f,g,h,i,j)}catch(k){}}},pauseGame:function(){AkihabaraGamebox._pauseGame?(AkihabaraGamebox._pauseGame=!1,AkihabaraGamebox._nextframe()):AkihabaraGamebox._pauseGame=!0},showPauseMessage:function(){AkihabaraGamebox.blitFade(AkihabaraGamebox.getBufferContext(),{alpha:.5});var a=AkihabaraGamebox._screenCtx;a.fillStyle="#FFF",a.font="12px sans-serif",a.fillText("PAUSE",141,125)},_domgetabsposition:function(a){var b={x:0,y:0,h:0,w:0};for(b.h=a.offsetHeight,b.w=a.offsetWidth;null!=a;)b.y+=a.offsetTop,b.x+=a.offsetLeft,a=a.offsetParent;return b},setForcedIdle:function(a){this._forcedidle=a},getFlag:function(a){return this._flags[a]},setScreenBorder:function(a){this._border=a},initScreen:function(a,b){document.body.style.textAlign="center",document.body.style.height="100%",document.body.style.margin="0px",document.body.style.padding="0px",document.getElementsByTagName("html")[0].style.height="100%";var c=document.createElement("div");c.style.width="100%",c.style.height="100%",c.style.display="table",this._box=document.createElement("div"),this._box.style.display="table-cell",this._box.style.width="100%",this._box.style.textAlign="center",this._box.style.verticalAlign="middle",this._screen=document.createElement("canvas"),this._screenCtx=this._screen.getContext("2d"),this._border&&(this._screen.style.border="1px solid black"),this._screen.setAttribute("height",b),this._screen.setAttribute("width",a),this._screen.style.width=a*this._zoom+"px",this._screen.style.height=b*this._zoom+"px",this._screenh=b,this._screenw=a,this._screenhh=Math.floor(b/2),this._screenhw=Math.floor(a/2),this._camera.x=0,this._camera.y=0,this._camera.h=b,this._camera.w=a,AkihabaraGamebox._container=this._box,this._box.appendChild(this._screen),c.appendChild(this._box),document.body.appendChild(c),this.createCanvas("_buffer"),AkihabaraInput.addKeyListernerTo(AkihabaraGamebox),AkihabaraInput.focusDrivenKeyboardSuport(AkihabaraGamebox),AkihabaraInput.addTouchEventsTo(AkihabaraGamebox._screen);var d=new Date;switch(AkihabaraGamebox._sessioncache=d.getDate()+"-"+d.getMonth()+"-"+d.getFullYear()+"-"+d.getHours()+"-"+d.getMinutes()+"-"+d.getSeconds(),AkihabaraGamebox._flags.fse){case"scanlines":AkihabaraGamebox.createCanvas("-gbox-fse",{w:a,h:b}),AkihabaraGamebox.getCanvasContext("-gbox-fse").save(),AkihabaraGamebox.getCanvasContext("-gbox-fse").globalAlpha=.2,AkihabaraGamebox.getCanvasContext("-gbox-fse").fillStyle=AkihabaraGamebox.COLOR_BLACK;for(var e=0;b>e;e+=2)AkihabaraGamebox.getCanvasContext("-gbox-fse").fillRect(0,e,a,1);AkihabaraGamebox.getCanvasContext("-gbox-fse").restore(),AkihabaraGamebox._localflags.fse=!0;break;case"lcd":AkihabaraGamebox.createCanvas("-gbox-fse-old",{w:a,h:b}),AkihabaraGamebox.createCanvas("-gbox-fse-new",{w:a,h:b}),AkihabaraGamebox._localflags.fse=!0}},setDoubleBuffering:function(a){this._db=a},setFps:function(a){this._fps=a,this._mspf=Math.floor(1e3/a)},decideFrame:function(a,b){return b.frames[Math.floor(a/b.speed)%b.frames.length]},decideFrameOnce:function(a,b){return b.frames[a>=b.frames.length*b.speed?b.frames.length-1:Math.floor(a/b.speed)]},isLastFrameOnce:function(a,b){return a>=b.frames.length*b.speed},getFps:function(){return this._fps},setAutoskip:function(a){this._autoskip=a},setFrameskip:function(a){this._frameskip=a},getScreenH:function(){return this._screenh},getScreenW:function(){return this._screenw},getScreenHH:function(){return this._screenhh},getScreenHW:function(){return this._screenhw},setZoom:function(a){this._zoom=a},setCallback:function(a){this._cb=a},_playobject:function(a,b,c){AkihabaraGamebox._objects[a][b].initialize&&(AkihabaraGamebox._objects[a][b].initialize(b),delete AkihabaraGamebox._objects[a][b].initialize),AkihabaraGamebox._objects[a][b][c]&&AkihabaraGamebox._objects[a][b][c](b,c)},_nextframe:function(){AkihabaraGamebox._framestart=AkihabaraGamebox._mspf-((new Date).getTime()-AkihabaraGamebox._framestart),AkihabaraGamebox._autoskip&&(AkihabaraGamebox._framestart<AkihabaraGamebox._autoskip.lowidle&&AkihabaraGamebox._frameskip<AkihabaraGamebox._autoskip.max?AkihabaraGamebox.setFrameskip(AkihabaraGamebox._frameskip+1):AkihabaraGamebox._framestart>AkihabaraGamebox._autoskip.hiidle&&AkihabaraGamebox._frameskip>AkihabaraGamebox._autoskip.min&&AkihabaraGamebox.setFrameskip(AkihabaraGamebox._frameskip-1)),AkihabaraGamebox._pauseGame?AkihabaraGamebox.showPauseMessage():this._gametimer=setTimeout(AkihabaraGamebox.go,AkihabaraGamebox._framestart<=0?1:AkihabaraGamebox._framestart),"undefined"!=typeof AkihabaraDebug&&AkihabaraDebug.run(AkihabaraGamebox._debugTool)
},_applyfse:function(){switch(AkihabaraGamebox._flags.fse){case"scanlines":AkihabaraGamebox.getBufferContext().drawImage(AkihabaraGamebox.getCanvas("-gbox-fse"),0,0);break;case"lcd":AkihabaraGamebox._localflags.fselcdget&&AkihabaraGamebox.getBuffer()&&AkihabaraGamebox.getCanvasContext("-gbox-fse-new").drawImage(AkihabaraGamebox.getBuffer(),0,0);var a=AkihabaraGamebox.getBufferContext();a.save(),a.globalAlpha=.5,a.drawImage(AkihabaraGamebox.getCanvas("-gbox-fse-old"),0,0),a.restore(),AkihabaraGamebox._localflags.fselcdget&&AkihabaraGamebox.swapCanvas("-gbox-fse-new","-gbox-fse-old"),AkihabaraGamebox._localflags.fselcdget=!AkihabaraGamebox._localflags.fselcdget}},onLoad:function(a){this.addEventListener(window,"load",a)},go:function(){if(AkihabaraGamebox._loaderqueue.isBusy()){if(1===AkihabaraGamebox._gamewaiting&&(AkihabaraGamebox.blitFade(AkihabaraGamebox._screenCtx,{alpha:.5}),AkihabaraGamebox.blitText(AkihabaraGamebox._screenCtx,{font:"_dbf",dx:2,dy:2,text:"LOADING..."}),AkihabaraGamebox._gamewaiting=!0),AkihabaraGamebox._gamewaiting<=1){var a=Math.floor((AkihabaraGamebox.getScreenW()-4)*AkihabaraGamebox._loaderqueue.getDone()/AkihabaraGamebox._loaderqueue.getSize());AkihabaraGamebox._screenCtx.globalAlpha=1,AkihabaraGamebox._screenCtx.fillStyle=AkihabaraGamebox._splash.gaugeLittleBackColor,AkihabaraGamebox._screenCtx.fillRect(0,4+AkihabaraGamebox.getFont("_dbf").tileh,AkihabaraGamebox.getScreenW(),1),AkihabaraGamebox._screenCtx.fillStyle=AkihabaraGamebox._splash.gaugeLittleColor,AkihabaraGamebox._screenCtx.fillRect(0,4+AkihabaraGamebox.getFont("_dbf").tileh,a>0?a:0,1),AkihabaraGamebox._screenCtx.restore(),AkihabaraDebug.setStatBar("Loading... ("+AkihabaraGamebox._loaderqueue.getDone()+"/"+AkihabaraGamebox._loaderqueue.getTotal()+")")}AkihabaraGamebox._gamewaiting&&AkihabaraGamebox._gamewaiting--,setTimeout(AkihabaraGamebox.go,1e3)}else{AkihabaraGamebox._gamewaiting=3,AkihabaraGamebox._framestart=(new Date).getTime();for(var b,c=0;c<AkihabaraGamebox._renderorder.length;c++)if(AkihabaraGamebox._groupplay[AkihabaraGamebox._renderorder[c]])if(AkihabaraGamebox._renderorder[c]===AkihabaraGamebox.ZINDEX_LAYER){var d;for(b=0;b<AkihabaraGamebox._actionqueue.length;b++)for(d=AkihabaraGamebox._zindex.first;null!=d;)AkihabaraGamebox._groupplay[AkihabaraGamebox._zindex.data[d].g]&&AkihabaraGamebox._playobject(AkihabaraGamebox._zindex.data[d].g,AkihabaraGamebox._zindex.data[d].o,AkihabaraGamebox._actionqueue[b]),d=AkihabaraGamebox._zindex.data[d].__next}else for(b=0;b<AkihabaraGamebox._actionqueue.length;b++)for(var e in AkihabaraGamebox._objects[AkihabaraGamebox._renderorder[c]])AkihabaraGamebox._playobject(AkihabaraGamebox._renderorder[c],e,AkihabaraGamebox._actionqueue[b]);if(AkihabaraGamebox._fskid>=AkihabaraGamebox._frameskip?(AkihabaraGamebox._localflags.fse&&AkihabaraGamebox._applyfse(),AkihabaraGamebox._db&&AkihabaraGamebox.blitImageToScreen(AkihabaraGamebox.getBuffer()),AkihabaraGamebox._fskid=0):AkihabaraGamebox._fskid++,AkihabaraGamebox.purgeGarbage(),AkihabaraGamebox._zindexch.length){for(b=0;b<AkihabaraGamebox._zindexch.length;b++)AkihabaraGamebox._objects[AkihabaraGamebox._zindexch[b].o.g][AkihabaraGamebox._zindexch[b].o.o]&&(null==AkihabaraGamebox._objects[AkihabaraGamebox._zindexch[b].o.g][AkihabaraGamebox._zindexch[b].o.o].__zt?AkihabaraGamebox._objects[AkihabaraGamebox._zindexch[b].o.g][AkihabaraGamebox._zindexch[b].o.o].__zt=AkihabaraGamebox._zindex.addObject(AkihabaraGamebox._zindexch[b].o,AkihabaraGamebox._zindexch[b].z):AkihabaraGamebox._zindex.setPrio(AkihabaraGamebox._objects[AkihabaraGamebox._zindexch[b].o.g][AkihabaraGamebox._zindexch[b].o.o].__zt,AkihabaraGamebox._zindexch[b].z));AkihabaraGamebox._zindexch=[]}for(var f in AkihabaraInput._keymap)-1===AkihabaraInput._keyboard[AkihabaraInput._keymap[f]]?AkihabaraInput._keyboard[AkihabaraInput._keymap[f]]=0:AkihabaraInput._keyboard[AkihabaraInput._keymap[f]]&&AkihabaraInput._keyboard[AkihabaraInput._keymap[f]]<100&&AkihabaraInput._keyboard[AkihabaraInput._keymap[f]]++;AkihabaraGamebox._forcedidle?this._gametimer=setTimeout(AkihabaraGamebox._nextframe,AkihabaraGamebox._forcedidle):AkihabaraGamebox._nextframe()}},setZindex:function(a,b){(null==a.__zt||a.zindex!==b)&&(a.zindex=b,this._zindexch.push({o:{g:a.group,o:a.id},z:b}))},getCamera:function(){return this._camera},setCameraY:function(a,b){this._camera.y=a,this._camera.y+this._camera.h>b.h&&(this._camera.y=b.h-this._screenh),this._camera.y<0&&(this._camera.y=0)},setCameraX:function(a,b){this._camera.x=a,this._camera.x+this._camera.w>b.w&&(this._camera.x=b.w-this._screenw),this._camera.x<0&&(this._camera.x=0)},centerCamera:function(a,b){this.setCameraX(a.x-this._screenhw,b),this.setCameraY(a.y-this._screenhh,b)},getGroups:function(){return this._groups},setGroups:function(a){this._groups=a,this._groupplay[AkihabaraGamebox.ZINDEX_LAYER]=!0;for(var b=0;b<a.length;b++)this._objects[a[b]]||(this._objects[a[b]]={},this._groupplay[a[b]]=!0,this._renderorder[b]=a[b])},setRenderOrder:function(a){this._renderorder=a},playGroup:function(a){this._groupplay[a]=!0},stopGroup:function(a){this._groupplay[a]=!1},toggleGroup:function(a){this._groupplay[a]=!this._groupplay[a]},soloGroup:function(a){for(var b=0;b<this._groups.length;b++)this._groups[b]===a?this.playGroup(this._groups[b]):this.stopGroup(this._groups[b])},playAllGroups:function(){for(var a=0;a<this._groups.length;a++)this.playGroup(this._groups[a])},clearGroup:function(a){for(var b in this._objects[a])null!=this._objects[a][b].__zt&&this._zindex.remove(this._objects[a][b].__zt),delete this._objects[a][b]},playGroups:function(a){for(var b=0;b<a.length;b++)this.playGroup(a[b])},stopGroups:function(a){for(var b=0;b<a.length;b++)this.stopGroup(a[b])},toggleGroups:function(a){for(var b=0;b<a.length;b++)this.toggleGroup(a[b])},getObject:function(a,b){return this._objects[a][b]},addFont:function(a){a.tilehh=Math.floor(a.tileh/2),a.tilehw=Math.floor(a.tilew/2),this._fonts[a.id]=a,this._fonts[a.id].firstascii=a.firstletter.charCodeAt(0)},getFont:function(a){return this._fonts[a]},trashObject:function(a){this._garbage[a.group]||(this._garbage[a.group]={}),this._garbage[a.group][a.id]=1,a.__trashing=!0},purgeGarbage:function(){for(var a in this._garbage)for(var b in this._garbage[a])this._objects[a][b].onpurge&&this._objects[a][b].onpurge(),null!=this._objects[a][b].__zt&&this._zindex.remove(this._objects[a][b].__zt),delete this._objects[a][b];AkihabaraGamebox._garbage={}},trashGroup:function(a){this._garbage[a]||(this._garbage[a]={});for(var b in this._objects[a])this._garbage[a][b]=1},objectIsTrash:function(a){return a.__trashing},addObject:function(a){return a.id||(a.id="obj-"+this._autoid,this._autoid=(this._autoid+1)%1e3),a.tileset&&(null==a.h&&(a.h=this._tiles[a.tileset].tileh),null==a.w&&(a.w=this._tiles[a.tileset].tilew),null==a.hw&&(a.hw=this._tiles[a.tileset].tilehw),null==a.hh&&(a.hh=this._tiles[a.tileset].tilehh)),this._objects[a.group][a.id]=a,null!=a.zindex&&this.setZindex(this._objects[a.group][a.id],a.zindex),this._objects[a.group][a.id]},groupIsEmpty:function(a){for(var b in this._objects[a])return!1;return!0},createCanvas:function(a,b){this.deleteCanvas(a);var c=b&&b.w?b.w:this._screenw,d=b&&b.h?b.h:this._screenh;this._canvas[a]=document.createElement("canvas"),this._canvas[a].setAttribute("height",d),this._canvas[a].setAttribute("width",c);var e=this._canvas[a].getContext("2d");e.save(),e.globalAlpha=0,e.fillStyle=AkihabaraGamebox.COLOR_BLACK,e.fillRect(0,0,c,d),e.restore()},swapCanvas:function(a,b){var c=this._canvas[a];this._canvas[a]=this._canvas[b],this._canvas[b]=c},deleteCanvas:function(a){this._canvas[a]&&delete this._canvas[a]},imageIsLoaded:function(a){return this._images[a]&&this._images[a].getAttribute("wasloaded")&&this._images[a].width},getImage:function(a){return this._images[a]},getBuffer:function(){return AkihabaraGamebox._fskid>=AkihabaraGamebox._frameskip?this._db?this.getCanvas("_buffer"):this._screen:null},getBufferContext:function(){return AkihabaraGamebox._fskid>=AkihabaraGamebox._frameskip?this._db?this.getCanvasContext("_buffer"):this._screenCtx:null},getCanvas:function(a){return this._canvas[a]},getCanvasContext:function(a){return this.getCanvas(a).getContext("2d")},addImage:function(a,b){if(this._images[a]){if(this._images[a].getAttribute("src_org")===b)return;delete this._images[a]}this._addtoloader({type:"image",id:a,filename:b})},deleteImage:function(a){delete this._images[a]},addTiles:function(a){a.tilehh=Math.floor(a.tileh/2),a.tilehw=Math.floor(a.tilew/2),this._tiles[a.id]=a},getTiles:function(a){return this._tiles[a]},loadAll:function(a){this._canlog&&(this.log=window.console.log),this._cb||(this._cb=a),this.addImage("_dbf",this.getDebugFont()),this._splash.background&&this.addImage("_splash",this._splash.background),AkihabaraGamebox.addFont({id:"_dbf",image:"_dbf",firstletter:" ",tileh:5,tilew:4,tilerow:16,gapx:0,gapy:0}),AkihabaraGamebox._splash.minimalTime||(AkihabaraGamebox._minimalexpired=2),this._waitforloaded()},_implicitsargs:function(a){a.camera&&(a.dx-=this._camera.x,a.dy-=this._camera.y),a.sourcecamera&&(a.x=this._camera.x*(a.parallaxx?a.parallaxx:1),a.y=this._camera.y*(a.parallaxy?a.parallaxy:1))},blitTile:function(a,b){if(null!=a){var c=this._tiles[b.tileset],d=this.getImage(c.image);this._implicitsargs(b),a.save(),a.globalAlpha=b.alpha?b.alpha:1,a.translate(b.fliph?c.tilew:0,b.flipv?c.tileh:0),a.scale(b.fliph?-1:1,b.flipv?-1:1),this._safedrawimage(a,d,c.gapx+c.tilew*(b.tile%c.tilerow),c.gapy+c.tileh*Math.floor(b.tile/c.tilerow),null==b.w?c.tilew:b.w,null==b.h?c.tileh:b.h,b.dx*(b.fliph?-1:1),b.dy*(b.flipv?-1:1),b.w?b.w:c.tilew,b.h?b.h:c.tileh),a.restore()}},blitAll:function(a,b,c){null!=a&&(this._implicitsargs(c),a.save(),a.globalAlpha=c.alpha?c.alpha:1,a.translate(c.fliph?b.width:0,c.flipv?b.height:0),a.scale(c.fliph?-1:1,c.flipv?-1:1),this._safedrawimage(a,b,0,0,b.width,b.height,c.dx*(c.fliph?-1:1),c.dy*(c.flipv?-1:1),b.width,b.height),a.restore())},blit:function(a,b,c){null!=a&&(this._implicitsargs(c),a.save(),a.globalAlpha=c.alpha?c.alpha:1,a.translate(c.fliph?c.dw:0,c.flipv?c.dh:0),a.scale(c.fliph?-1:1,c.flipv?-1:1),this._safedrawimage(a,b,c.x?c.x:0,c.y?c.y:0,c.w?c.w:c.dw,c.h?c.h:c.dh,c.dx*(c.fliph?-1:1),c.dy*(c.flipv?-1:1),c.dw,c.dh),a.restore())},blitTilemap:function(a,b){if(null!=a)for(var c=this._tiles[b.tileset],d=0;d<b.map.length;d++)for(var e=0;e<b.map[d].length;e++)null!=b.map[d][e]&&this.blitTile(a,{tileset:b.tileset,tile:b.map[d][e],dx:e*c.tilew,dy:d*c.tilew})},blitText:function(a,b){if(null!=a){b.text+="";var c=this._fonts[b.font],d=0;this._implicitsargs(b);var e=b.dx,f=b.dy;b.valign===AkihabaraGamebox.ALIGN_BOTTOM?f=f+b.dh-c.tileh:b.valign===AkihabaraGamebox.ALIGN_MIDDLE&&(f=f+Math.floor(b.dh/2)-c.tileh),b.halign===AkihabaraGamebox.ALIGN_RIGHT?e=e+b.dw-b.text.length*c.tilew:b.halign===AkihabaraGamebox.ALIGN_CENTER&&(e+=Math.floor((b.dw-b.text.length*c.tilew)/2)),a.save(),a.globalAlpha=b.alpha?b.alpha:1;for(var g=0;g<b.text.length;g++)d=b.text.charCodeAt(g)-c.firstascii,d>=0&&(b.clear&&a.clearRect(e+g*c.tilew,f,b.w?b.w:c.tilew,b.h?b.h:c.tileh),this._safedrawimage(a,this.getImage(c.image),c.gapx+c.tilew*(d%c.tilerow),c.gapy+c.tileh*Math.floor(d/c.tilerow),c.tilew,c.tileh,e+g*c.tilew,f,b.w?b.w:c.tilew,b.h?b.h:c.tileh));a.restore()}},blitClear:function(a,b){null!=a&&(null==b&&(b={x:0,y:0}),this._implicitsargs(b),a.clearRect(b.x,b.y,null==b.w?a.canvas.width:b.w,null==b.h?a.canvas.height:b.h))},blitImageToScreen:function(a){this._screenCtx.drawImage(a,0,0)},blitFade:function(a,b){a&&this.blitRect(a,{x:0,y:0,w:a.canvas.width,h:a.canvas.height,alpha:b.alpha,color:b.color})},blitRect:function(a,b){null!=a&&(a.save(),a.globalAlpha=b.alpha?b.alpha:1,a.fillStyle=b.color?b.color:AkihabaraGamebox.COLOR_BLACK,a.fillRect(b.x,b.y,b.w,b.h),a.restore())},collides:function(a,b,c){return c||(c=0),!(a.y+a.h-1-c<b.y+c||a.y+c>b.y+b.h-1-c||a.x+a.w-1-c<b.x+c||a.x+c>b.x+b.w-1-c)},pixelcollides:function(a,b,c){return c||(c=0),!(a.y<b.y+c||a.y>b.y+b.h-1-c||a.x<b.x+c||a.x>b.x+b.w-1-c)},objectIsVisible:function(a){return this.collides(a,this._camera,0)},_minimaltimeexpired:function(){AkihabaraGamebox._minimalexpired=2},_splashscreeniscompleted:function(){return(AkihabaraGamebox._splash.background?AkihabaraGamebox.imageIsLoaded("_splash"):!0)&&(AkihabaraGamebox._splash.minilogo?AkihabaraGamebox.imageIsLoaded("logo"):!0)&&(AkihabaraGamebox._splash.footnotes?AkihabaraGamebox.imageIsLoaded("_dbf"):!0)},setBasePath:function(a){this._basepath=a},setSplashSettings:function(a){for(var b in a)this._splash[b]=a[b]},setOfflineCache:function(a){this._flags.offlinecache=a},setDebugFont:function(a){this._debugfont=a},addScript:function(a){AkihabaraGamebox._addtoloader({type:"script",call:a})},addBundle:function(a){AkihabaraGamebox._addtoloader({type:"bundle",call:a})},readBundleData:function(pack,call){var i=0;if(pack.setObject)for(i=0;i<pack.setObject.length;i++)eval("("+pack.setObject[i].object+")")[pack.setObject[i].property]=pack.setObject[i].value;if(pack.addFont)for(i=0;i<pack.addFont.length;i++)AkihabaraGamebox.addFont(pack.addFont[i]);if(pack.addTiles)for(i=0;i<pack.addTiles.length;i++)AkihabaraGamebox.addTiles(pack.addTiles[i]);if(pack.addImage)for(i=0;i<pack.addImage.length;i++)AkihabaraGamebox.addImage(pack.addImage[i][0],pack.addImage[i][1]);if(pack.addBundle)for(i=0;i<pack.addBundle.length;i++)AkihabaraGamebox.addBundle(pack.addBundle[i]);if(pack.addScript)for(i=0;i<pack.addScript.length;i++)AkihabaraGamebox.addScript(pack.addScript[i]);pack.onLoad&&AkihabaraGamebox._addtoloader({type:"exec-onl",func:pack.onLoad,call:call,pack:pack}),call.onLoad&&AkihabaraGamebox._addtoloader({type:"exec-onl",func:call.onLoad,call:call,pack:pack})},_xmlhttp:null,_loaderqueue:AkihabaraCyclelist.create(200),_loadercache:AkihabaraCachelist.create(30),_loaderimageloaded:function(){this.setAttribute("wasloaded",!0),this.hheight=Math.floor(this.height/2),this.hwidth=Math.floor(this.width/2),AkihabaraGamebox._loaderloaded()},_loaderhmlhttploading:function(){var rs="undefined"!=typeof this.readyState?this.readyState:AkihabaraGamebox._xmlhttp.readyState,st="undefined"!=typeof this.status?this.status:AkihabaraGamebox._xmlhttp.status,rt="undefined"!=typeof this.responseText?this.responseText:AkihabaraGamebox._xmlhttp.responseText;if(4===rs&&(!st||200===st)&&rt){AkihabaraGamebox._loaderqueue.getCurrent().call.skipCacheSave||AkihabaraGamebox._loadercache.add(AkihabaraGamebox._loaderqueue.getCurrent().call.file,rt);var pack=eval("("+rt+")");AkihabaraGamebox.readBundleData(pack,AkihabaraGamebox._loaderqueue.getCurrent().call),AkihabaraGamebox._loaderloaded()}},_addtoloader:function(a){AkihabaraGamebox._loaderqueue.push(a),AkihabaraGamebox._loaderqueue.isProcessing()||AkihabaraGamebox._loadnext()},_loaderloaded:function(){setTimeout(AkihabaraGamebox._loadnext,10)},_loaderscript:function(){AkihabaraGamebox._loaderqueue.getCurrent().call.onLoad&&AkihabaraGamebox._addtoloader({type:"exec-onl",func:AkihabaraGamebox._loaderqueue.getCurrent().call.onLoad,call:AkihabaraGamebox._loaderqueue.getCurrent().call}),AkihabaraGamebox._loadnext()},_loadnext:function(){var current=AkihabaraGamebox._loaderqueue.pop();if(AkihabaraGamebox._loaderqueue.isProcessing())switch(AkihabaraGamebox._loaderqueue.getCurrent().type){case"image":AkihabaraGamebox._images[current.id]=new Image,AkihabaraGamebox.addEventListener(AkihabaraGamebox._images[current.id],"load",AkihabaraGamebox._loaderimageloaded),AkihabaraGamebox._images[current.id].src=AkihabaraGamebox._breakcacheurl(current.filename),AkihabaraGamebox._images[current.id].setAttribute("src_org",current.filename),AkihabaraGamebox._images[current.id].setAttribute("id",current.id),AkihabaraGamebox._images[current.id].setAttribute("wasloaded",!1);break;case"bundle":var done=!1;if(!current.call.skipCacheLoad){var data=AkihabaraGamebox._loadercache.read(current.call.file);if(data){var pack=eval("("+data+")");AkihabaraGamebox.readBundleData(pack,current.call),AkihabaraGamebox._loaderloaded(),done=!0}}done||(AkihabaraGamebox._xmlhttp=AkihabaraGamebox.createXmlHttpRequest(),AkihabaraGamebox._xmlhttp.open(current.call.data?"POST":"GET",AkihabaraGamebox._breakcacheurl(current.call.file),!0),AkihabaraGamebox._xmlhttp.onreadystatechange=AkihabaraGamebox._loaderhmlhttploading,current.call.data?(AkihabaraGamebox._xmlhttp.setRequestHeader("Content-type","application/x-www-form-urlencoded"),AkihabaraGamebox._xmlhttp.send(current.call.data)):AkihabaraGamebox._xmlhttp.send());break;case"exec-onl":current.func(current.call,current.pack),AkihabaraGamebox._loaderloaded();break;case"script":var script=document.createElement("script");script.type="text/javascript",script.onload=AkihabaraGamebox._loaderscript,script.src=current.call.file,document.getElementsByTagName("body")[0].appendChild(script)}},_waitforloaded:function(){var a=0,b=0;if(AkihabaraGamebox._loaderqueue.isBusy()||2!==AkihabaraGamebox._minimalexpired){if(AkihabaraGamebox._screenCtx.save(),!AkihabaraGamebox._minimalexpired&&AkihabaraGamebox._splashscreeniscompleted()&&(AkihabaraGamebox._minimalexpired=1,setTimeout(AkihabaraGamebox._minimaltimeexpired,AkihabaraGamebox._splash.minimalTime)),AkihabaraGamebox._splash.loading&&AkihabaraGamebox._splash.loading(AkihabaraGamebox._screenCtx,AkihabaraGamebox._loaderqueue.getDone(),AkihabaraGamebox._loaderqueue.getTotal()),"c64"===AkihabaraGamebox._flags.loadscreen){for(var c=0,d=0;c!==AkihabaraGamebox.getScreenH();)d=10+Math.floor(Math.random()*AkihabaraGamebox.getScreenH()/4),c+d>AkihabaraGamebox.getScreenH()&&(d=AkihabaraGamebox.getScreenH()-c),c+=d;AkihabaraGamebox._screenCtx.fillStyle=AkihabaraGamebox.PALETTES.c64.colors.lightblue,AkihabaraGamebox._screenCtx.fillRect(Math.floor(AkihabaraGamebox.getScreenW()/10),Math.floor(AkihabaraGamebox.getScreenH()/10),AkihabaraGamebox.getScreenW()-Math.floor(AkihabaraGamebox.getScreenW()/5),AkihabaraGamebox.getScreenH()-Math.floor(AkihabaraGamebox.getScreenH()/5)),AkihabaraGamebox._splash.minilogo&&AkihabaraGamebox.imageIsLoaded("logo")&&(a=AkihabaraGamebox.getScreenW()/4,b=AkihabaraGamebox.getImage("logo").height*a/AkihabaraGamebox.getImage("logo").width)}else{if(AkihabaraGamebox._splash.minilogo&&AkihabaraGamebox.imageIsLoaded("logo")&&(a=AkihabaraGamebox.getScreenW()/4,b=AkihabaraGamebox.getImage("logo").height*a/AkihabaraGamebox.getImage("logo").width),AkihabaraGamebox._splash.footnotes&&AkihabaraGamebox.imageIsLoaded("_dbf")){if(!AkihabaraGamebox.getCanvas("_footnotes")){var e=AkihabaraGamebox.getFont("_dbf");AkihabaraGamebox.createCanvas("_footnotes",{w:AkihabaraGamebox.getScreenW()-5,h:AkihabaraGamebox._splash.footnotes.length*(e.tileh+AkihabaraGamebox._splash.footnotesSpacing)})}AkihabaraGamebox.blitAll(AkihabaraGamebox._screenCtx,AkihabaraGamebox.getCanvas("_footnotes"),{dx:5,dy:AkihabaraGamebox.getScreenH()-AkihabaraGamebox.getCanvas("_footnotes").height-5})}if(AkihabaraGamebox._loaderqueue.isBusy()){Math.floor((AkihabaraGamebox.getScreenW()-4)*AkihabaraGamebox._loaderqueue.getDone()/AkihabaraGamebox._loaderqueue.getTotal())}}AkihabaraGamebox._screenCtx.restore(),"undefined"!=typeof AkihabaraDebug&&AkihabaraDebug.setStatBar("Loading... ("+AkihabaraGamebox._loaderqueue.getDone()+"/"+AkihabaraGamebox._loaderqueue.getTotal()+")"),setTimeout(AkihabaraGamebox._waitforloaded,50)}else AkihabaraGamebox.deleteImage("_splash"),"undefined"!=typeof AkihabaraDebug&&AkihabaraDebug.setStatBar(),AkihabaraGamebox._cb()},clearCache:function(){this._loadercache.clear()},checkCanvasSupport:function(){return!!document.createElement("canvas").getContext},addEventListener:function(a,b,c){a.addEventListener?a.addEventListener(b,c,!1):a.attachEvent("on"+b,c)},removeEventListener:function(a,b,c){a.removeEventListener?a.removeEventListener(b,c,!1):a.detachEvent("on"+b,c)},createXmlHttpRequest:function(){var a=!1;if(!a)try{a=new XMLHttpRequest}catch(b){a=!1}return a}},AkihabaraIphopad={_buttonsize:50,_buttonsize2:100,_buttonsize3:150,_gapx:0,_gapy:0,_width:0,_height:0,_center:{},_cross:{up:!1,down:!1,left:!1,right:!1},_buttons:{a:!1,b:!1,c:!1},_transl:.125*Math.PI,_brad:.25*Math.PI,_swap:!1,_positions:[{up:!1,down:!1,left:!1,right:!0},{up:!1,down:!0,left:!1,right:!0},{up:!1,down:!0,left:!1,right:!1},{up:!1,down:!0,left:!0,right:!1},{up:!1,down:!1,left:!0,right:!1},{up:!0,down:!1,left:!0,right:!1},{up:!0,down:!1,left:!1,right:!1},{up:!0,down:!1,left:!1,right:!0}],_listen:function(a){var b,c={up:!1,down:!1,left:!1,right:!1},d={a:!1,b:!1,c:!1};for(b=0;b<a.touches.length;b++){var e={x:a.touches[b].pageX-AkihabaraIphopad._gapx,y:a.touches[b].pageY-AkihabaraIphopad._gapy};e.x<AkihabaraIphopad._height?c=AkihabaraIphopad._positions[Math.floor(AkihabaraTrigo.getAngle(AkihabaraIphopad._center,e,AkihabaraIphopad._transl)/AkihabaraIphopad._brad)]:e.x>AkihabaraIphopad._width-AkihabaraIphopad._buttonsize?d.a=!0:e.x>AkihabaraIphopad._width-AkihabaraIphopad._buttonsize2?d.b=!0:e.x>AkihabaraIphopad._width-AkihabaraIphopad._buttonsize3&&(d.c=!0)}this._swap=!this._swap;for(b in this._cross)c[b]!==AkihabaraIphopad._cross[b]&&(c[b]?AkihabaraInput._keydown({fake:!0,keyCode:AkihabaraInput._keymap[b]}):AkihabaraInput._keyup({fake:!0,keyCode:AkihabaraInput._keymap[b]}));for(b in this._buttons)d[b]!==AkihabaraIphopad._buttons[b]&&(d[b]?AkihabaraInput._keydown({fake:!0,keyCode:AkihabaraInput._keymap[b]}):AkihabaraInput._keyup({fake:!0,keyCode:AkihabaraInput._keymap[b]}));AkihabaraIphopad._cross=c,AkihabaraIphopad._buttons=d},_fakelisten:function(a){AkihabaraIphopad._listen({touches:[{pageX:a.clientX,pageY:a.clientY}]})},initialize:function(a){var b=document.createElement("div");b.style.margin="auto",b.style.padding="0px",b.style.height=a.h+"px",b.style.width="100%",b.style.backgroundImage="url("+a.bg+")",b.style.backgroundRepeat="repeat-x";var c=document.createElement("div");c.style.cssFloat="left",c.style.padding="0px",c.style.margin="0px",c.style.height=a.h+"px",c.style.width=a.h+"px",c.style.backgroundImage="url("+a.dpad+")",c.style.backgroundRepeat="no-repeat";var d=document.createElement("div");d.style.cssFloat="right",d.style.padding="0px",d.style.margin="0px",d.style.height=a.h+"px",d.style.width=AkihabaraIphopad._buttonsize3+"px",d.style.backgroundImage="url("+a.buttons+")",d.style.backgroundRepeat="no-repeat",b.appendChild(c),b.appendChild(d),AkihabaraGamebox._box.appendChild(b),b.ontouchstart=function(a){a.preventDefault(),a.stopPropagation(),AkihabaraIphopad._listen(a)},b.ontouchend=function(a){a.preventDefault(),a.stopPropagation(),AkihabaraIphopad._listen(a)},b.ontouchmove=function(a){a.preventDefault(),a.stopPropagation(),AkihabaraIphopad._listen(a)};var e=AkihabaraGamebox._domgetabsposition(b);this._gapx=e.x,this._gapy=e.y,this._width=e.w,this._height=e.h,this._center={x:Math.floor(this._height/2),y:Math.floor(this._height/2)}}},AkihabaraToys={TOY_BUSY:0,TOY_DONE:1,TOY_IDLE:2,resetToy:function(a,b){a.toys&&delete a.toys[b]},getToyValue:function(a,b,c,d){return null==a.toys||null==a.toys[b]?d:a.toys[b][c]},getToyStatus:function(a,b){return null==a.toys||null==a.toys[b]?AkihabaraToys.TOY_BUSY:a.toys[b].__status},_toydone:function(a,b){return a.toys[b].__status<AkihabaraToys.TOY_IDLE&&a.toys[b].__status++,a.toys[b].__status},_toybusy:function(a,b){return a.toys[b].__status=AkihabaraToys.TOY_BUSY,a.toys[b].__status},_toyfrombool:function(a,b,c){return c?AkihabaraToys._toydone(a,b):AkihabaraToys._toybusy(a,b)},_maketoy:function(a,b){return a.toys||(a.toys={}),a.toys[b]?!1:(a.toys[b]={__status:AkihabaraToys.TOY_BUSY},!0)},timer:{randomly:function(a,b,c){return AkihabaraToys._maketoy(a,b)&&(a.toys[b].time=AkihabaraHelpers.random(c.base,c.range)),a.toys[b].time?(a.toys[b].time--,AkihabaraToys._toybusy(a,b)):(a.toys[b].time=AkihabaraHelpers.random(c.base,c.range),AkihabaraToys._toydone(a,b))},real:function(a,b,c){return AkihabaraToys._maketoy(a,b)&&(a.toys[b].subtimer=AkihabaraGamebox.getFps(),a.toys[b].done=!1,a.toys[b].time=c.countdown?c.countdown:0),a.toys[b].subtimer--,a.toys[b].subtimer||(a.toys[b].subtimer=AkihabaraGamebox.getFps(),c.countdown?a.toys[b].time?(a.toys[b].time--,c.audiocritical&&a.toys[b].time<=c.critical&&AkihabaraMediaBox.hitAudio(c.audiocritical)):a.toys[b].done=!0:a.toys[b].time++),AkihabaraToys._toyfrombool(a,b,a.toys[b].done)},every:function(a,b,c){return AkihabaraToys._maketoy(a,b)&&(a.toys[b].timer=0),a.toys[b].timer++,a.toys[b].timer===c?(a.toys[b].timer=0,AkihabaraToys._toydone(a,b)):AkihabaraToys._toybusy(a,b)},after:function(a,b,c){return AkihabaraToys._maketoy(a,b)&&(a.toys[b].timer=0),a.toys[b].timer===c?AkihabaraToys._toydone(a,b):(a.toys[b].timer++,AkihabaraToys._toybusy(a,b))}},logic:{once:function(a,b,c){return AkihabaraToys._maketoy(a,b)&&(a.toys[b].done=!1),a.toys[b].done?!1:(c&&(a.toys[b].done=!0),c)}},ui:{menu:function(a,b,c){if(AkihabaraToys._maketoy(a,b)||c.resetmenu){var d=AkihabaraGamebox.getFont(c.font);a.toys[b].selected=c.selected?c.selected:0,a.toys[b].ok=0;var e,f=0;for(e=0;e<c.items.length;e++)c.items[e].length>f&&(f=c.items[e].length);for(AkihabaraGamebox.createCanvas("menu-"+b,{w:f*d.tilew,h:c.items.length*d.tileh}),e=0;e<c.items.length;e++)AkihabaraGamebox.blitText(AkihabaraGamebox.getCanvasContext("menu-"+b),{font:c.font,text:c.items[e],dx:0,dy:d.tileh*e});a.toys[b].fh=d.tileh,a.toys[b].fw=d.tilew}return a.toys[b].ok||(AkihabaraInput.keyIsHit(c.keys.up)&&a.toys[b].selected>0?(c.audiooption&&AkihabaraMediaBox.hitAudio(c.audiooption),a.toys[b].selected--):AkihabaraInput.keyIsHit(c.keys.down)&&a.toys[b].selected<c.items.length-1?(c.audiooption&&AkihabaraMediaBox.hitAudio(c.audiooption),a.toys[b].selected++):AkihabaraInput.keyIsHit(c.keys.ok)?(c.audioconfirm&&AkihabaraMediaBox.hitAudio(c.audioconfirm),a.toys[b].ok=1):AkihabaraInput.keyIsHit(c.keys.cancel)&&(a.toys[b].ok=-1)),AkihabaraGamebox.blitAll(AkihabaraGamebox.getBufferContext(),AkihabaraGamebox.getCanvas("menu-"+b),{dx:c.x+a.toys[b].fw,dy:c.y,camera:c.camera}),a.toys[b].ok%2===0&&AkihabaraGamebox.blitText(AkihabaraGamebox.getBufferContext(),{font:c.font,text:c.selector,dx:c.x,dy:c.y+a.toys[b].selected*a.toys[b].fh,camera:c.camera}),a.toys[b].ok?a.toys[b].ok>0&&a.toys[b].ok<10?(a.toys[b].ok++,void AkihabaraToys._toybusy(a,b)):AkihabaraToys._toydone(a,b):AkihabaraToys._toybusy(a,b)},hud:function(a){return AkihabaraGamebox.createCanvas(a),{w:{},surfaceid:a,updateWidget:function(a){if(!this.w[a].__hidden){var b;if("label"===this.w[a].widget&&(this.w[a].text=null!=this.w[a].prepad?AkihabaraHelpers.prepad(this.w[a].value,this.w[a].prepad,this.w[a].padwith):null!=this.w[a].postpad?AkihabaraHelpers.postpad(this.w[a].value,this.w[a].postpad,this.w[a].padwith):this.w[a].value+"",AkihabaraGamebox.blitText(AkihabaraGamebox.getCanvasContext(this.surfaceid),this.w[a])),"symbols"===this.w[a].widget){b=AkihabaraGamebox.getTiles(this.w[a].tileset),AkihabaraGamebox.blitClear(AkihabaraGamebox.getCanvasContext(this.surfaceid),{x:this.w[a].dx,y:this.w[a].dy,w:(this.w[a].maxshown-1)*this.w[a].gapx+b.tilew,h:(this.w[a].maxshown-1)*this.w[a].gapy+b.tileh});for(var c=this.w[a].value,d=0;d<this.w[a].maxshown;d++)c>0?AkihabaraGamebox.blitTile(AkihabaraGamebox.getCanvasContext(this.surfaceid),{tileset:this.w[a].tileset,tile:this.w[a].tiles[c>this.w[a].tiles.length?this.w[a].tiles.length-1:c-1],dx:this.w[a].dx+d*this.w[a].gapx,dy:this.w[a].dy+d*this.w[a].gapy,fliph:this.w[a].fliph,flipv:this.w[a].flipv}):null!=this.w[a].emptytile&&AkihabaraGamebox.blitTile(AkihabaraGamebox.getCanvasContext(this.surfaceid),{tileset:this.w[a].tileset,tile:this.w[a].emptytile,dx:this.w[a].dx+d*this.w[a].gapx,dy:this.w[a].dy+d*this.w[a].gapy,fliph:this.w[a].fliph,flipv:this.w[a].flipv}),c-=this.w[a].tiles.length}if("stack"===this.w[a].widget){b=AkihabaraGamebox.getTiles(this.w[a].tileset);var e=(this.w[a].maxshown-1)*this.w[a].gapx+b.tilew;AkihabaraGamebox.blitClear(AkihabaraGamebox.getCanvasContext(this.surfaceid),{x:this.w[a].dx-(this.w[a].rightalign?e:0),y:this.w[a].dy,w:e,h:(this.w[a].maxshown-1)*this.w[a].gapy+b.tileh});for(var f=0;f<this.w[a].maxshown;f++)f<this.w[a].value.length&&AkihabaraGamebox.blitTile(AkihabaraGamebox.getCanvasContext(this.surfaceid),{tileset:this.w[a].tileset,tile:this.w[a].value[f],dx:this.w[a].rightalign?this.w[a].dx-b.tileh-this.w[a].gapx*f:this.w[a].dx+f*this.w[a].gapx,dy:this.w[a].dy+f*this.w[a].gapy,fliph:this.w[a].fliph,flipv:this.w[a].flipv})}"radio"===this.w[a].widget&&(b=AkihabaraGamebox.getTiles(this.w[a].tileset),AkihabaraGamebox.blitClear(AkihabaraGamebox.getCanvasContext(this.surfaceid),{x:this.w[a].dx,y:this.w[a].dy,w:b.tilew,h:b.tileh}),AkihabaraGamebox.blitTile(AkihabaraGamebox.getCanvasContext(this.surfaceid),{tileset:this.w[a].tileset,tile:this.w[a].frames[this.w[a].value],dx:this.w[a].dx,dy:this.w[a].dy,fliph:this.w[a].fliph,flipv:this.w[a].flipv})),"blit"===this.w[a].widget&&(b=AkihabaraGamebox.getTiles(this.w[a].tileset),AkihabaraGamebox.blitClear(AkihabaraGamebox.getCanvasContext(this.surfaceid),{x:this.w[a].dx,y:this.w[a].dy,w:b.tilew,h:b.tileh}),AkihabaraGamebox.blitTile(AkihabaraGamebox.getCanvasContext(this.surfaceid),{tileset:this.w[a].tileset,tile:this.w[a].value,dx:this.w[a].dx,dy:this.w[a].dy,fliph:this.w[a].fliph,flipv:this.w[a].flipv})),"bool"===this.w[a].widget&&(b=AkihabaraGamebox.getTiles(this.w[a].tileset),AkihabaraGamebox.blitClear(AkihabaraGamebox.getCanvasContext(this.surfaceid),{x:this.w[a].dx,y:this.w[a].dy,w:b.tilew,h:b.tileh}),this.w[a].value&&AkihabaraGamebox.blitTile(AkihabaraGamebox.getCanvasContext(this.surfaceid),{tileset:this.w[a].tileset,tile:this.w[a].frame,dx:this.w[a].dx,dy:this.w[a].dy,fliph:this.w[a].fliph,flipv:this.w[a].flipv})),"gauge"===this.w[a].widget&&(b=AkihabaraGamebox.getTiles(this.w[a].tileset),AkihabaraGamebox.blitTile(AkihabaraGamebox.getCanvasContext(this.surfaceid),{tileset:this.w[a].tileset,tile:0,dx:this.w[a].dx,dy:this.w[a].dy}),AkihabaraGamebox.blitTile(AkihabaraGamebox.getCanvasContext(this.surfaceid),{tileset:this.w[a].tileset,tile:1,dx:this.w[a].dx,dy:this.w[a].dy,w:this.w[a].value*b.tilew/this.w[a].maxvalue}))}},hideWidgets:function(a){for(var b=0;b<a.length;b++)this.w[a[b]].__hidden=!0;this.redraw()},showWidgets:function(a){for(var b=0;b<a.length;b++)this.w[a[b]].__hidden=!1;this.redraw()},getValue:function(a,b){return this.w[a][b]},getNumberValue:function(a,b){return 1*this.w[a][b]},setValue:function(a,b,c){this.w[a][b]!==c&&("value"===b&&(null!=this.w[a].maxvalue&&c>this.w[a].maxvalue&&(c=this.w[a].maxvalue),null!=this.w[a].minvalue&&c<this.w[a].minvalue&&(c=this.w[a].minvalue),"radio"===this.w[a].widget&&(c%=this.w[a].frames.length)),this.w[a][b]=c,this.updateWidget(a))},pushValue:function(a,b,c){this.w[a][b].push(c),this.updateWidget(a)},addValue:function(a,b,c){c&&this.setValue(a,b,this.w[a][b]+c)},setWidget:function(a,b){this.w[a]=b,this.updateWidget(a)},redraw:function(){AkihabaraGamebox.blitClear(AkihabaraGamebox.getCanvasContext(this.surfaceid));for(var a in this.w)this.updateWidget(a)},blit:function(){AkihabaraGamebox.blitAll(AkihabaraGamebox.getBufferContext(),AkihabaraGamebox.getCanvas(this.surfaceid),{dx:0,dy:0})}}}},fullscreen:{fadeout:function(a,b,c,d){return(AkihabaraToys._maketoy(a,b)||d.resetfade)&&(a.toys[b].fade=0),a.toys[b].fade+=d.fadespeed,a.toys[b].fade>1&&(a.toys[b].fade=1),d.alpha=a.toys[b].fade,AkihabaraGamebox.blitFade(c,d),AkihabaraToys._toyfrombool(a,b,1===a.toys[b].fade)},fadein:function(a,b,c,d){return(AkihabaraToys._maketoy(a,b)||d.resetfade)&&(a.toys[b].fade=1),a.toys[b].fade-=d.fadespeed,a.toys[b].fade<0&&(a.toys[b].fade=0),a.toys[b].fade&&(d.alpha=a.toys[b].fade,AkihabaraGamebox.blitFade(c,d)),AkihabaraToys._toyfrombool(a,b,0===a.toys[b].fade)}},text:{blink:function(a,b,c,d){return AkihabaraToys._maketoy(a,b)&&(a.toys[b].texttimer=0,a.toys[b].visible=!1,a.toys[b].times=0),a.toys[b].texttimer>=d.blinkspeed?(a.toys[b].texttimer=0,a.toys[b].visible=!a.toys[b].visible,d.times&&a.toys[b].times++):a.toys[b].texttimer++,a.toys[b].visible&&AkihabaraGamebox.blitText(c,d),AkihabaraToys._toyfrombool(a,b,d.times?d.times<a.toys[b].times:!1)},fixed:function(a,b,c,d){return AkihabaraToys._maketoy(a,b)?a.toys[b].texttimer=0:a.toys[b].texttimer++,AkihabaraGamebox.blitText(c,d),AkihabaraToys._toyfrombool(a,b,d.time<a.toys[b].texttimer)
}},logos:{linear:function(a,b,c){return AkihabaraToys._maketoy(a,b)&&(a.toys[b].x=c.sx,a.toys[b].y=c.sy,a.toys[b].every=c.every,a.toys[b].played=!1),a.toys[b].every?a.toys[b].every--:(c.x!==a.toys[b].x||c.y!==a.toys[b].y?Math.abs(c.x-a.toys[b].x)<=c.speed&&Math.abs(c.y-a.toys[b].y)<=c.speed?(a.toys[b].x=c.x,a.toys[b].y=c.y):AkihabaraTrigo.translate(a.toys[b],AkihabaraTrigo.getAngle(a.toys[b],c),c.speed):a.toys[b].played||(c.audioreach&&AkihabaraMediaBox.hitAudio(c.audioreach),a.toys[b].played=!0),a.toys[b].every=c.every),c.text?AkihabaraGamebox.blitText(AkihabaraGamebox.getBufferContext(),{font:c.font,dx:a.toys[b].x,dy:a.toys[b].y,text:c.text}):c.tileset?AkihabaraGamebox.blitTile(AkihabaraGamebox.getBufferContext(),{tileset:c.tileset,tile:c.tile,dx:a.toys[b].x,dy:a.toys[b].y,camera:c.camera,fliph:c.fliph,flipv:c.flipv,alpha:c.alpha}):AkihabaraGamebox.blitAll(AkihabaraGamebox.getBufferContext(),AkihabaraGamebox.getImage(c.image),{dx:a.toys[b].x,dy:a.toys[b].y,alpha:c.alpha}),AkihabaraToys._toyfrombool(a,b,c.x===a.toys[b].x&&c.y===a.toys[b].y)},crossed:function(a,b,c){return AkihabaraToys._maketoy(a,b)&&(a.toys[b].gapx=c.gapx,a.toys[b].lw=AkihabaraGamebox.getImage(c.image).height,a.toys[b].done=!1),a.toys[b].gapx?(a.toys[b].gapx-=c.speed,a.toys[b].gapx<0&&(a.toys[b].gapx=0),AkihabaraGamebox.blitAll(AkihabaraGamebox.getBufferContext(),AkihabaraGamebox.getImage(c.image),{dx:c.x-a.toys[b].gapx,dy:c.y,alpha:c.alpha}),AkihabaraGamebox.blitAll(AkihabaraGamebox.getBufferContext(),AkihabaraGamebox.getImage(c.image),{dx:c.x+a.toys[b].gapx,dy:c.y,alpha:c.alpha}),AkihabaraToys._toybusy(a,b)):(a.toys[b].done||(a.toys[b].done=!0,c.audioreach&&AkihabaraMediaBox.hitAudio(c.audioreach)),AkihabaraGamebox.blitAll(AkihabaraGamebox.getBufferContext(),AkihabaraGamebox.getImage(c.image),{dx:c.x,dy:c.y}),AkihabaraToys._toydone(a,b))},zoomout:function(a,b,c){return AkihabaraToys._maketoy(a,b)&&(a.toys[b].zoom=c.zoom,a.toys[b].done=!1,a.toys[b].img=AkihabaraGamebox.getImage(c.image)),1!==a.toys[b].zoom?(a.toys[b].zoom-=c.speed,a.toys[b].zoom<=1&&(a.toys[b].zoom=1,c.audioreach&&AkihabaraMediaBox.hitAudio(c.audioreach)),AkihabaraGamebox.blit(AkihabaraGamebox.getBufferContext(),AkihabaraGamebox.getImage(c.image),{h:a.toys[b].img.height,w:a.toys[b].img.width,dx:c.x-Math.floor(a.toys[b].img.width*(a.toys[b].zoom-1)/2),dy:c.y-Math.floor(a.toys[b].img.height*(a.toys[b].zoom-1)/2),dh:Math.floor(a.toys[b].img.height*a.toys[b].zoom),dw:Math.floor(a.toys[b].img.width*a.toys[b].zoom),alpha:1/a.toys[b].zoom}),AkihabaraToys._toybusy(a,b)):(AkihabaraGamebox.blitAll(AkihabaraGamebox.getBufferContext(),AkihabaraGamebox.getImage(c.image),{dx:c.x,dy:c.y}),AkihabaraToys._toydone(a,b))},rising:function(a,b,c){return AkihabaraToys._maketoy(a,b)&&(a.toys[b].cnt=0,a.toys[b].lh=AkihabaraGamebox.getImage(c.image).height,a.toys[b].lw=AkihabaraGamebox.getImage(c.image).width,a.toys[b].done=!1),a.toys[b].cnt<a.toys[b].lh?(a.toys[b].cnt+=c.speed,a.toys[b].cnt>a.toys[b].lh&&(a.toys[b].gapx=a.toys[b].lh),AkihabaraGamebox.blit(AkihabaraGamebox.getBufferContext(),AkihabaraGamebox.getImage(c.image),{dh:a.toys[b].cnt,dw:a.toys[b].lw,dx:c.x,dy:c.y+a.toys[b].lh-a.toys[b].cnt,alpha:c.alpha}),c.reflex&&AkihabaraGamebox.blit(AkihabaraGamebox.getBufferContext(),AkihabaraGamebox.getImage(c.image),{dh:a.toys[b].cnt,dw:a.toys[b].lw,dx:c.x,dy:c.y+a.toys[b].lh,alpha:c.reflex,flipv:!0}),a.toys[b].cnt>=a.toys[b].lh&&c.audioreach&&AkihabaraMediaBox.hitAudio(c.audioreach),AkihabaraToys._toybusy(a,b)):(AkihabaraGamebox.blitAll(AkihabaraGamebox.getBufferContext(),AkihabaraGamebox.getImage(c.image),{dx:c.x,dy:c.y}),c.reflex&&AkihabaraGamebox.blitAll(AkihabaraGamebox.getBufferContext(),AkihabaraGamebox.getImage(c.image),{dx:c.x,dy:c.y+a.toys[b].lh,alpha:c.reflex,flipv:!0}),AkihabaraToys._toydone(a,b))},bounce:function(a,b,c){return AkihabaraToys._maketoy(a,b)&&(a.toys[b].accy=c.accy,a.toys[b].y=c.y,a.toys[b].h=AkihabaraGamebox.getImage(c.image).height,a.toys[b].done=!1),a.toys[b].done||(a.toys[b].y+a.toys[b].h>=c.floory?(c.audiobounce&&AkihabaraMediaBox.hitAudio(c.audiobounce),a.toys[b].y=c.floory-a.toys[b].h,a.toys[b].accy=-Math.ceil(a.toys[b].accy/(c.heavy?c.heavy:2)),a.toys[b].done=0===a.toys[b].accy):a.toys[b].accy--,a.toys[b].y-=a.toys[b].accy),AkihabaraGamebox.blitAll(AkihabaraGamebox.getBufferContext(),AkihabaraGamebox.getImage(c.image),{dx:c.x,dy:a.toys[b].y}),AkihabaraToys._toyfrombool(a,b,a.toys[b].done)}},dialogue:{render:function(a,b,c){if(AkihabaraToys._maketoy(a,b)&&(a.toys[b].newscene=!0,a.toys[b].sceneid=-1,a.toys[b].ended=!1,a.toys[b].timer=0,a.toys[b].counter=0,a.toys[b].anim=0,AkihabaraGamebox.createCanvas("dialogue-"+b)),!c.hideonend||c.hideonend&&!a.toys[b].ended){if(a.toys[b].newscene&&!a.toys[b].ended&&(a.toys[b].anim=0,a.toys[b].timer=0,a.toys[b].newscene=!1,a.toys[b].sceneid++,a.toys[b].ended=a.toys[b].sceneid===c.scenes.length,!a.toys[b].ended)){if(a.toys[b].letter=0,a.toys[b].wait=!1,a.toys[b].scene=c.scenes[a.toys[b].sceneid],a.toys[b].fd=AkihabaraGamebox.getFont(a.toys[b].scene.font?a.toys[b].scene.font:c.font),a.toys[b].sceneH=a.toys[b].scene.dh?a.toys[b].scene.dh:AkihabaraGamebox.getScreenH(),a.toys[b].sceneW=a.toys[b].scene.dw?a.toys[b].scene.dw:AkihabaraGamebox.getScreenW(),a.toys[b].sceneX=a.toys[b].scene.dx?a.toys[b].scene.dx:0,a.toys[b].sceneY=a.toys[b].scene.dy?a.toys[b].scene.dy:0,AkihabaraGamebox.blitClear(AkihabaraGamebox.getCanvasContext("dialogue-"+b)),a.toys[b].scene.slide&&AkihabaraGamebox.blitAll(AkihabaraGamebox.getCanvasContext("dialogue-"+b),AkihabaraGamebox.getImage(a.toys[b].scene.slide.image),{dx:a.toys[b].scene.slide.x,dy:a.toys[b].scene.slide.y}),a.toys[b].scene.scroller){AkihabaraGamebox.createCanvas("scroller-"+b,{w:a.toys[b].sceneW,h:a.toys[b].scene.scroller.length*(a.toys[b].fd.tileh+a.toys[b].scene.spacing)});for(var d=0;d<a.toys[b].scene.scroller.length;d++)AkihabaraGamebox.blitText(AkihabaraGamebox.getCanvasContext("scroller-"+b),{font:a.toys[b].fd.id,dx:0,dy:d*(a.toys[b].fd.tileh+a.toys[b].scene.spacing),dw:a.toys[b].sceneW,halign:AkihabaraGamebox.ALIGN_CENTER,text:a.toys[b].scene.scroller[d]})}a.toys[b].scene.bonus&&AkihabaraGamebox.createCanvas("bonus-"+b,{w:a.toys[b].sceneW,h:a.toys[b].scene.bonus.length*(a.toys[b].fd.tileh+a.toys[b].scene.spacing)}),a.toys[b].scene.audiomusic&&AkihabaraMediaBox.hitAudio(a.toys[b].scene.audiomusic)}if(!a.toys[b].ended)if(a.toys[b].wait)AkihabaraInput.keyIsHit(c.esckey)?a.toys[b].ended=!0:AkihabaraInput.keyIsHit(c.skipkey)&&(a.toys[b].newscene=!0);else if(AkihabaraInput.keyIsHit(c.esckey)?a.toys[b].ended=!0:AkihabaraInput.keyIsHold(c.skipkey)?a.toys[b].counter=a.toys[b].scene.speed:a.toys[b].counter++,a.toys[b].scene.talk){if(a.toys[b].counter===a.toys[b].scene.speed){a.toys[b].letter++,a.toys[b].counter=0,a.toys[b].scene.audio&&a.toys[b].letter%3===0&&AkihabaraMediaBox.hitAudio(a.toys[b].scene.audio);for(var e=a.toys[b].letter,f=0;e>a.toys[b].scene.talk[f].length;)if(e-=a.toys[b].scene.talk[f].length,f++,f===a.toys[b].scene.talk.length){f=-1;break}f>=0?AkihabaraGamebox.blitText(AkihabaraGamebox.getCanvasContext("dialogue-"+b),{font:c.font,dx:c.who[a.toys[b].scene.who].x,dy:c.who[a.toys[b].scene.who].y+f*a.toys[b].fd.tileh,text:a.toys[b].scene.talk[f].substr(0,e)}):a.toys[b].wait=!0}}else if(a.toys[b].scene.scroller)a.toys[b].counter===a.toys[b].scene.speed&&(a.toys[b].letter++,a.toys[b].counter=0,a.toys[b].letter===AkihabaraGamebox.getCanvas("scroller-"+b).height+a.toys[b].scene.push&&(a.toys[b].wait=!0));else if(a.toys[b].scene.bonus){for(var g=0;g<=a.toys[b].letter;g++)a.toys[b].scene.bonus[g].text?AkihabaraGamebox.blitText(AkihabaraGamebox.getCanvasContext("bonus-"+b),{font:c.font,dx:0,dy:g*(a.toys[b].fd.tileh+a.toys[b].scene.spacing),text:a.toys[b].scene.bonus[g].text}):a.toys[b].scene.bonus[g].mul&&(a.toys[b].scene.bonus[g].tmptext=a.toys[b].scene.bonus[g].mask.replace(/%VAL%/,a.toys[b].timer).replace(/%MUL%/,a.toys[b].scene.bonus[g].mul).replace(/%TOT%/,a.toys[b].timer*a.toys[b].scene.bonus[g].mul),AkihabaraGamebox.blitText(AkihabaraGamebox.getCanvasContext("bonus-"+b),{clear:!0,font:c.font,dx:0,dy:g*(a.toys[b].fd.tileh+a.toys[b].scene.spacing),text:a.toys[b].scene.bonus[g].tmptext}));if(!a.toys[b].wait){var h=!1;a.toys[b].scene.bonus[a.toys[b].letter].mul&&!a.toys[b].scene.bonus[a.toys[b].letter].text?a.toys[b].counter>=a.toys[b].scene.bonus[a.toys[b].letter].speed&&(a.toys[b].counter=0,a.toys[b].timer++,a.toys[b].timer>a.toys[b].scene.bonus[a.toys[b].letter].mulvalue?(a.toys[b].scene.bonus[a.toys[b].letter].text=a.toys[b].scene.bonus[a.toys[b].letter].tmptext,h=!0):a.toys[b].scene.bonus[a.toys[b].letter].callback&&a.toys[b].scene.bonus[a.toys[b].letter].callback(a.toys[b].scene.bonus[a.toys[b].letter],a.toys[b].scene.bonus[a.toys[b].letter].arg)):a.toys[b].counter>=a.toys[b].scene.speed&&(h=!0),h&&(a.toys[b].letter===a.toys[b].scene.bonus.length-1?a.toys[b].wait=!0:(a.toys[b].letter++,a.toys[b].scene.bonus[a.toys[b].letter].mul&&(a.toys[b].scene.bonus[a.toys[b].letter].text=null,a.toys[b].scene.bonus[a.toys[b].letter].tmptext=null,a.toys[b].timer=0),a.toys[b].counter=0))}}a.toys[b].scene.talk?(c.who[a.toys[b].scene.who].box&&AkihabaraGamebox.blitRect(AkihabaraGamebox.getBufferContext(),c.who[a.toys[b].scene.who].box),c.who[a.toys[b].scene.who].tileset&&(a.toys[b].anim=(a.toys[b].anim+1)%20,AkihabaraGamebox.blitTile(AkihabaraGamebox.getBufferContext(),{tileset:c.who[a.toys[b].scene.who].tileset,tile:AkihabaraGamebox.decideFrame(a.toys[b].anim,c.who[a.toys[b].scene.who].frames),dx:c.who[a.toys[b].scene.who].portraitx,dy:c.who[a.toys[b].scene.who].portraity,camera:!1,fliph:c.who[a.toys[b].scene.who].fliph,flipv:c.who[a.toys[b].scene.who].flipv})),AkihabaraGamebox.blitAll(AkihabaraGamebox.getBufferContext(),AkihabaraGamebox.getCanvas("dialogue-"+b),{dx:0,dy:0})):a.toys[b].scene.scroller?AkihabaraGamebox.blit(AkihabaraGamebox.getBufferContext(),AkihabaraGamebox.getCanvas("scroller-"+b),{dx:a.toys[b].sceneX,dy:a.toys[b].sceneY+(a.toys[b].letter<a.toys[b].sceneH?a.toys[b].sceneH-a.toys[b].letter:0),dw:a.toys[b].sceneW,y:a.toys[b].letter<a.toys[b].sceneH?0:a.toys[b].letter-a.toys[b].sceneH,dh:a.toys[b].letter<a.toys[b].sceneH?a.toys[b].letter:a.toys[b].sceneH}):a.toys[b].scene.bonus&&AkihabaraGamebox.blitAll(AkihabaraGamebox.getBufferContext(),AkihabaraGamebox.getCanvas("bonus-"+b),{dx:a.toys[b].sceneX,dy:a.toys[b].sceneY})}return AkihabaraToys._toyfrombool(a,b,a.toys[b].ended)}},generate:{sparks:{simple:function(a,b,c,d){var e=AkihabaraGamebox.getTiles(d.tileset);if(null==d.frames){d.frames={speed:null==d.animspeed?1:d.animspeed,frames:[]};for(var f=0;f<e.tilerow;f++)d.frames.frames[f]=f}var g=AkihabaraGamebox.addObject(Akihabara.extendsFrom({id:c,group:b,x:a.x+a.hw-e.tilehw+(null==d.gapx?0:d.gapx),y:"top"===d.valign?a.y:a.y+a.hh-e.tilehh+(null==d.gapy?0:d.gapy),tileset:d.tileset,alpha:null,accx:0,accy:0,frame:0,timer:d.delay?-d.delay:-1,frames:d.frames,toptimer:d.frames.frames.length*d.frames.speed-1,camera:a.camera,gravity:!1,trashoffscreen:!0,fliph:null==d.fliph?a.fliph:d.fliph,flipv:null==d.flipv?a.flipv:d.flipv,blinkspeed:0},d));return g[null==d.logicon?"first":d.logicon]=function(){this.timer++,this.timer>=0&&(this.x+=this.accx,this.y+=this.accy,this.gravity&&this.accy++,(this.timer===this.toptimer||this.trashoffscreen&&!AkihabaraGamebox.objectIsVisible(this))&&AkihabaraGamebox.trashObject(this))},g[null==d.bliton?"blit":d.bliton]=function(){this.timer>=0&&(!this.blinkspeed||Math.floor(this.timer/this.blinkspeed)%2)&&AkihabaraGamebox.blitTile(AkihabaraGamebox.getBufferContext(),{tileset:this.tileset,tile:AkihabaraGamebox.decideFrame(this.timer,this.frames),dx:this.x,dy:this.y,camera:this.camera,fliph:this.fliph,flipv:this.flipv,alpha:this.alpha})},g},popupText:function(a,b,c,d){d.text+="";var e=AkihabaraGamebox.getFont(d.font),f=AkihabaraGamebox.addObject(Akihabara.extendsFrom({id:c,group:b,x:Math.floor(a.x+a.hw-e.tilehw*d.text.length),y:a.y-e.tilehh,vaccy:-d.jump,font:"small",keep:0,text:d.text+"",cnt:0,camera:a.camera},d));return f.initialize=function(){var a=AkihabaraGamebox.getFont(this.font);AkihabaraGamebox.createCanvas("poptext-"+this.id,{w:this.text.length*a.tilew,h:a.tileh}),AkihabaraGamebox.blitText(AkihabaraGamebox.getCanvasContext("poptext-"+this.id),{font:this.font,text:this.text,dx:0,dy:0})},f.onpurge=function(){AkihabaraGamebox.deleteCanvas("poptext-"+this.id)},f[null==d.logicon?"first":d.logicon]=function(){AkihabaraGamebox.objectIsVisible(this)?(this.vaccy?this.vaccy++:this.cnt++,this.y+=this.vaccy,this.cnt>=this.keep&&AkihabaraGamebox.trashObject(this)):AkihabaraGamebox.trashObject(this)},f[null==d.bliton?"blit":d.bliton]=function(){AkihabaraGamebox.blitAll(AkihabaraGamebox.getBufferContext(),AkihabaraGamebox.getCanvas("poptext-"+this.id),{dx:this.x,dy:this.y,camera:this.camera})},f},bounceDie:function(a,b,c,d){var e=AkihabaraGamebox.addObject(Akihabara.extendsFrom({id:c,group:b,tileset:a.tileset,frame:a.frame,side:a.side,frames:a.frames.die,x:a.x,y:a.y,vaccy:-d.jump,accx:0,flipv:d.flipv,cnt:0,blinkspeed:0,camera:a.camera},d));return e[null==d.logicon?"first":d.logicon]=function(){AkihabaraGamebox.objectIsVisible(this)?(this.vaccy++,this.y+=this.vaccy,this.x+=this.accx,this.cnt++):AkihabaraGamebox.trashObject(this)},e[null==d.bliton?"blit":d.bliton]=function(){(!this.blinkspeed||Math.floor(this.cnt/this.blinkspeed)%2)&&AkihabaraGamebox.blitTile(AkihabaraGamebox.getBufferContext(),{tileset:this.tileset,tile:AkihabaraGamebox.decideFrame(this.cnt,this.frames),dx:this.x,dy:this.y,camera:this.camera,fliph:this.side,flipv:this.flipv})},e}}}},AkihabaraTile={getTileInMap:function(a,b,c,d,e){e||(e="map");var f=AkihabaraGamebox._tiles[c.tileset],g=Math.floor(a/f.tilew),h=Math.floor(b/f.tileh);return 0>h||h>=c[e].length?d:0>g||g>=c[e][h].length?d:c[e][h][g]},asciiArtToMap:function(a,b){if(b instanceof Array){var c={};for(var d in b)c[b[d][1]]=b[d][0];b=c}var e,f=[];for(var g in b){e=g.length;break}for(var h=0;h<a.length;h++){for(var i=[],j=a[h],k=0;k<j.length;k+=e)i.push(b[j.substr(k,e)]);f.push(i)}return f},finalizeTilemap:function(a){var b=AkihabaraGamebox._tiles[a.tileset];return a.h=a.map.length*b.tileh,a.w=a.map[0].length*b.tilew,a.hw=Math.floor(a.w/2),a.hh=Math.floor(a.h/2),a},xPixelToTileX:function(a,b){var c=AkihabaraGamebox._tiles[a.tileset];return Math.floor(b/c.tilew)},yPixelToTileY:function(a,b){var c=AkihabaraGamebox._tiles[a.tileset];return Math.floor(b/c.tileh)},xPixelToTile:function(a,b,c){var d=AkihabaraGamebox._tiles[a.tileset];return(Math.floor(b/d.tilew)+(c?c:0))*d.tilew},yPixelToTile:function(a,b,c){var d=AkihabaraGamebox._tiles[a.tileset];return(Math.floor(b/d.tileh)+(c?c:0))*d.tileh},setTileInMap:function(a,b,c,d,e,f){var g=AkihabaraGamebox.getTiles(b.tileset);b[null==f?"map":f][d][c]=e,null==e?AkihabaraGamebox.blitClear(a,{x:c*g.tilew,y:d*g.tilew,h:g.tileh,w:g.tilew}):AkihabaraGamebox.blitTile(a,{tileset:b.tileset,tile:e,dx:c*g.tilew,dy:d*g.tilew})},setTileInMapAtPixel:function(a,b,c,d,e,f){var g=AkihabaraGamebox.getTiles(b.tileset);c=Math.floor(c/g.tilew),d=Math.floor(d/g.tileh),AkihabaraTile.setTileInMap(a,b,c,d,e,f)}},AkihabaraHelpers={searchObject:function(a,b,c){if(!a)return null;for(var d=0;d<a.length;a++)if(a[d][b]===c)return a[d];return null},seq:function(a,b,c){for(var d=[],e=a;b>e;e+=null==c?1:c)d.push(e);return d},multiplier:function(a,b){return!a||2>a?1:a*(b?b:1)},prepad:function(a,b,c){for(a+="";a.length<b;)a=c+a;return a},postpad:function(a,b,c){for(a+="";a.length<b;)a+=c;return a},random:function(a,b){return a+Math.floor(Math.random()*b)},upAndDown:function(a,b){return a%b>b/2?b-a%b:a%b},limit:function(a,b,c){return b>a?b:a>c?c:a},goToZero:function(a){return a?a-a/Math.abs(a):0},getArrayCapped:function(a,b){return b>=a.length?a[a.length-1]:a[b]},getArrayIndexed:function(a,b,c){if(null==a[0][c])return a[0];for(var d=0;b>a[d][c]&&d!==a.length-1;)d++;return a[d]}},AkihabaraTools={_images:[],_loadedflag:[],_data:{},_count:0,_countloaded:0,_loaded:function(a){this._loadedflag[a]=!0,AkihabaraTools._countloaded++,document.title=AkihabaraTools._countloaded+"/"+AkihabaraTools._count;for(var b=0;b<this._images.length;b++)this._loadedflag[b]||(document.title+=this._images[b].src+", ")},_loadall:function(){AkihabaraTools._count!==AkihabaraTools._countloaded?setTimeout(AkihabaraTools._loadall,1e3):AkihabaraTools._allloaded()},makecels:function(a){this._data=a;for(var b=function(){AkihabaraTools._loaded(this.id)},c=0,d=0;d<a.rows.length;d++)for(var e=0;e<a.rows[d].length;e++)this._images[c]=new Image,AkihabaraGamebox.addEventListener(this._images[c],"load",b),this._images[c].setAttribute("id",c),this._images[c].src=a.rows[d][e].img,this._count++,c++;this._loadall()},_allloaded:function(){var a,b,c=this._data,d=0,e=0,f=0,g=0;for(a=0;a<c.rows.length;a++){for(e+=1*this._images[g].height,f=0,b=0;b<c.rows[a].length;b++)f+=1*this._images[g].width,g++;f>d&&(d=f)}var h=document.createElement("canvas");h.style.border="1px solid red",h.setAttribute("height",e),h.setAttribute("width",d),document.body.appendChild(h);var i=h.getContext("2d"),j=0,k=0;for(g=0,a=0;a<c.rows.length;a++){for(j=0,b=0;b<c.rows[a].length;b++){if(i.drawImage(this._images[g],j,k),c.rows[a][b].filter&&c.rows[a][b].filter){for(var l=i.getImageData(j,k,this._images[g].width,this._images[g].height),m=l.data,n=0,o=m.length;o>n;n+=4){if(c.rows[a][b].filter.replace)for(var p=0;p<c.rows[a][b].filter.replace.length;p++){var q=c.rows[a][b].filter.replace[p].from,r=c.rows[a][b].filter.replace[p].to;m[n]===q.r&&m[n+1]===q.g&&m[n+2]===q.b&&m[n+3]===q.a&&(m[n]=r.r,m[n+1]=r.g,m[n+2]=r.b,m[n+3]=r.a)}c.rows[a][b].filter.color&&0!==m[n+3]&&(m[n]=c.rows[a][b].filter.color.r,m[n+1]=c.rows[a][b].filter.color.g,m[n+2]=c.rows[a][b].filter.color.b,m[n+3]=c.rows[a][b].filter.color.a)}i.putImageData(l,j,k)}j+=1*this._images[g].width,g++}k+=1*this._images[g-1].height}}},AkihabaraGamecycle={createMaingame:function(a,b){return AkihabaraGamebox.addObject({id:a,group:b,counter:0,difficulty:0,state:50,stateFirstIteration:!0,hud:{},changeLevel:function(){},newLife:function(){},gameDisclaimerAnimation:function(){return!0},gameIntroAnimation:function(a){return a?void AkihabaraToys.resetToy(this,"default-blinker"):(AkihabaraGamebox.blitFade(AkihabaraGamebox.getBufferContext(),{alpha:1}),AkihabaraToys.text.blink(this,"default-blinker",AkihabaraGamebox.getBufferContext(),{font:"small",text:"LETS BEGIN!",valign:AkihabaraGamebox.ALIGN_MIDDLE,halign:AkihabaraGamebox.ALIGN_CENTER,dx:0,dy:0,dw:AkihabaraGamebox.getScreenW(),dh:AkihabaraGamebox.getScreenH(),blinkspeed:5,times:6}))},levelIntroAnimation:function(a){return a?void AkihabaraToys.resetToy(this,"default-blinker"):(AkihabaraGamebox.blitFade(AkihabaraGamebox.getBufferContext(),{alpha:1}),AkihabaraToys.text.blink(this,"default-blinker",AkihabaraGamebox.getBufferContext(),{font:"small",text:"GET READY!",valign:AkihabaraGamebox.ALIGN_MIDDLE,halign:AkihabaraGamebox.ALIGN_CENTER,dx:0,dy:0,dw:AkihabaraGamebox.getScreenW(),dh:AkihabaraGamebox.getScreenH(),blinkspeed:5,times:6}))},newlifeIntroAnimation:function(a){return a?void AkihabaraToys.resetToy(this,"default-blinker"):(AkihabaraGamebox.blitFade(AkihabaraGamebox.getBufferContext(),{alpha:1}),AkihabaraToys.text.fixed(this,"default-blinker",AkihabaraGamebox.getBufferContext(),{font:"small",text:"GET READY!",valign:AkihabaraGamebox.ALIGN_MIDDLE,halign:AkihabaraGamebox.ALIGN_CENTER,dx:0,dy:0,dw:AkihabaraGamebox.getScreenW(),dh:AkihabaraGamebox.getScreenH(),time:30}))},gameoverIntroAnimation:function(a){return a?void AkihabaraToys.resetToy(this,"default-blinker"):(AkihabaraGamebox.blitFade(AkihabaraGamebox.getBufferContext(),{alpha:1}),AkihabaraToys.text.fixed(this,"default-blinker",AkihabaraGamebox.getBufferContext(),{font:"small",text:"GAME OVER",valign:AkihabaraGamebox.ALIGN_MIDDLE,halign:AkihabaraGamebox.ALIGN_CENTER,dx:0,dy:0,dw:AkihabaraGamebox.getScreenW(),dh:AkihabaraGamebox.getScreenH(),time:50}))},gameTitleIntroAnimation:function(a){a||(AkihabaraGamebox.blitFade(AkihabaraGamebox.getBufferContext(),{alpha:1}),AkihabaraGamebox.blitText(AkihabaraGamebox.getBufferContext(),{font:"small",text:"GAME TITLE",valign:AkihabaraGamebox.ALIGN_MIDDLE,halign:AkihabaraGamebox.ALIGN_CENTER,dx:0,dy:0,dw:AkihabaraGamebox.getScreenW(),dh:AkihabaraGamebox.getScreenH()-100}))},endlevelIntroAnimation:function(a){return a?void AkihabaraToys.resetToy(this,"default-blinker"):AkihabaraToys.text.blink(this,"default-blinker",AkihabaraGamebox.getBufferContext(),{font:"small",text:"WELL DONE!",valign:AkihabaraGamebox.ALIGN_MIDDLE,halign:AkihabaraGamebox.ALIGN_CENTER,dx:0,dy:0,dw:AkihabaraGamebox.getScreenW(),dh:AkihabaraGamebox.getScreenH(),blinkspeed:5,times:10})},gameEndingIntroAnimation:function(a){return a?void AkihabaraToys.resetToy(this,"default-blinker"):(AkihabaraGamebox.blitFade(AkihabaraGamebox.getBufferContext(),{alpha:1}),AkihabaraToys.text.blink(this,"default-blinker",AkihabaraGamebox.getBufferContext(),{font:"small",text:"CONGRATULATIONS!",valign:AkihabaraGamebox.ALIGN_MIDDLE,halign:AkihabaraGamebox.ALIGN_CENTER,dx:0,dy:0,dw:AkihabaraGamebox.getScreenW(),dh:AkihabaraGamebox.getScreenH(),blinkspeed:5,times:10}))},pressStartIntroAnimation:function(a){return a?void AkihabaraToys.resetToy(this,"default-blinker"):(AkihabaraToys.text.blink(this,"default-blinker",AkihabaraGamebox.getBufferContext(),{font:"small",text:"PRESS A TO START",valign:AkihabaraGamebox.ALIGN_MIDDLE,halign:AkihabaraGamebox.ALIGN_CENTER,dx:0,dy:Math.floor(AkihabaraGamebox.getScreenH()/3),dw:AkihabaraGamebox.getScreenW(),dh:2*Math.floor(AkihabaraGamebox.getScreenH()/3),blinkspeed:10}),AkihabaraInput.keyIsHit("a"))},gameIsOver:function(){return!0},gameEvents:function(){},gameMenu:function(a){return a?void AkihabaraToys.resetToy(this,"difficulty"):(AkihabaraGamebox.blitFade(AkihabaraGamebox.getBufferContext(),{alpha:.5}),AkihabaraToys.ui.menu(this,"difficulty",{audiooption:"default-menu-option",audioconfirm:"default-menu-confirm",font:"small",keys:{up:"up",down:"down",ok:"a",cancel:"b"},selector:" > ",items:["EASY","NORMAL","HARD"],x:10,y:10})?-1===AkihabaraToys.getToyValue(this,"difficulty","ok")?-1:(this.difficulty=AkihabaraToys.getToyValue(this,"difficulty","selected"),!0):!1)},gameIsHold:function(){return 400===this.state||401===this.state},isCompleted:function(){return 800===this.state},getNextLevel:function(){return this._nextlevel},gotoLevel:function(a){this._nextlevel=a,this.setState(400)},playerDied:function(a){this._loselife=a,this.setState(500)},gameIsCompleted:function(){this.setState(800)},setState:function(a){this.state=a,this.stateFirstIteration=!0},_resetGroups:function(){for(var a=AkihabaraGamebox.getGroups(),b=0;b<a.length;b++)a[b]!==this.group&&AkihabaraGamebox.clearGroup(a[b]);AkihabaraGamebox.soloGroup(this.group)},stateIsReady:function(){this.stateFirstIteration=!1},blit:function(){switch(this.state){case 50:this.stateFirstIteration&&(this._resetGroups(),this.gameDisclaimerAnimation(!0),this.stateIsReady()),this.gameDisclaimerAnimation(!1)&&this.setState(100);break;case 100:case 101:case 102:switch(this.stateFirstIteration&&100===this.state&&(this._resetGroups(),this.gameTitleIntroAnimation(!0)),this.gameTitleIntroAnimation(!1),this.state){case 100:this.stateFirstIteration&&(this.pressStartIntroAnimation(!0),this.stateIsReady()),this.pressStartIntroAnimation(!1)&&this.setState(101);break;case 101:this.stateFirstIteration&&(this.gameMenu(!0),this.stateIsReady());var a=this.gameMenu(!1);a&&this.setState(-1===a?100:102);break;case 102:this.stateFirstIteration&&(this._resetGroups(),AkihabaraToys.resetToy(this,"fadeout"),this.stateIsReady()),AkihabaraToys.fullscreen.fadeout(this,"fadeout",AkihabaraGamebox.getBufferContext(),{fadespeed:.05,audiochannelfade:"bgmusic"})&&this.setState(200)}break;case 200:case 300:case 301:case 400:case 401:case 402:case 500:case 501:case 600:case 601:case 700:case 800:case 801:if(this.stateFirstIteration){switch(this.state){case 200:AkihabaraToys.resetToy(this,"fadein"),this.level=null,this._nextlevel=null,this.hud=AkihabaraToys.ui.hud("maingamehud"),this.initializeGame(),this.gameIntroAnimation(!0);break;case 300:this.level=this._nextlevel,AkihabaraGamebox.playAllGroups(),this.changeLevel(this._nextlevel);break;case 800:case 400:this.endlevelIntroAnimation(!0),AkihabaraToys.resetToy(this,"fadeout");break;case 501:AkihabaraToys.resetToy(this,"fadeout");break;case 401:AkihabaraGamebox.soloGroup(this.group),this.levelIntroAnimation(!0);break;case 402:AkihabaraToys.resetToy(this,"fadein"),this.level=this._nextlevel,AkihabaraGamebox.playAllGroups(),this.changeLevel(this._nextlevel);break;case 600:AkihabaraGamebox.soloGroup(this.group),this.newlifeIntroAnimation(!0);break;case 500:this._loselife.counter=0;break;case 601:AkihabaraToys.resetToy(this,"fadein"),this.newLife(),AkihabaraGamebox.playAllGroups();break;case 700:AkihabaraGamebox.soloGroup(this.group),this.gameoverIntroAnimation(!0);break;case 801:AkihabaraGamebox.soloGroup(this.group),this.gameEndingIntroAnimation(!0)}this.stateIsReady()}switch(this.state){case 200:this.gameIntroAnimation(!1)&&this.setState(300);break;case 601:case 402:case 300:AkihabaraToys.fullscreen.fadein(this,"fadein",AkihabaraGamebox.getBufferContext(),{fadespeed:.05,audiochannelfade:"bgmusic"})&&this.setState(301);break;case 301:this.gameEvents();break;case 400:this.endlevelIntroAnimation(!1)&&AkihabaraToys.fullscreen.fadeout(this,"fadeout",AkihabaraGamebox.getBufferContext(),{fadespeed:.05,audiochannelfade:"bgmusic"})&&this.setState(401);break;case 800:this.endlevelIntroAnimation(!1)&&AkihabaraToys.fullscreen.fadeout(this,"fadeout",AkihabaraGamebox.getBufferContext(),{fadespeed:.05,audiochannelfade:"bgmusic"})&&this.setState(801);break;case 501:AkihabaraToys.fullscreen.fadeout(this,"fadeout",AkihabaraGamebox.getBufferContext(),{fadespeed:.05,audiochannelfade:"bgmusic"})&&this.setState(this.gameIsOver()?700:600);break;case 401:this.levelIntroAnimation(!1)&&this.setState(402);break;case 500:this._loselife.counter++,this._loselife.counter===this._loselife.wait&&this.setState(501);break;case 600:this.newlifeIntroAnimation(!1)&&this.setState(601);break;case 700:this.gameoverIntroAnimation(!1)&&this.setState(100);break;case 801:this.gameEndingIntroAnimation(!1)&&(this._loselife={ending:!0},this.setState(700))}this.hud.blit()}}})}},AkihabaraDevices={applyDefaultDesktopCapabilityOn:function(a){a.zoom=2},applyDefaultMobileCapabilityOn:function(a){a.touch=!0,a.width=320},isMobile:function(a){return!!{Android:!0,iPhone:!0,iPad:!0,iPod:!0}[a]},configurationFor:function(a){var b={},c=a.match(/Android|Chrome|Firefox|iPhone|iPad|konqueror|Minefield|nintendo wii|Opera|MSIE 9\.0|MSIE 7\.0/i)[0];switch(c){case"Android":AkihabaraDevices.android(b);break;case"Chrome":AkihabaraDevices.chrome(b);break;case"iPhone":AkihabaraDevices.iphone(b);break;case"iPad":AkihabaraDevices.ipad(b);break;case"iPod":AkihabaraDevices.ipod(b);break;case"konqueror":AkihabaraDevices.konqueror(b);break;case"Minefield":AkihabaraDevices.firefox(b);break;case"nintendo wii":AkihabaraDevices.nintendo_wii(b);break;default:b.zoom=2,b.audioisexperimental=!0}return b.canaudio=!!document.createElement("audio").canPlayType,AkihabaraDevices.isMobile(c)?AkihabaraDevices.applyDefaultMobileCapabilityOn(b):AkihabaraDevices.applyDefaultDesktopCapabilityOn(b),b},konqueror:function(a){a.audioteam=1,a.audioissinglechannel=!0,a.audiocompatmode=2,a.forcedmimeaudio="audio/ogg",a.audioisexperimental=!0},safari:function(a){a.audioteam=1},opera:function(a){a.audioteam=1,a.audiocreatemode=1},ie9:function(a){a.audioteam=2,a.audiocompatmode=1},ie7:function(a){a.audioteam=2,a.audiocompatmode=1,a.audioisexperimental=!0},firefox:function(a){a.audioteam=1},chrome:function(a){a.audioteam=3},android:function(a){a.audiocompatmode=2,a.audioteam=1,a.audioisexperimental=!0,a.audioissinglechannel=!0},iphone:function(a){a.audiocompatmode=2,a.audioteam=1,a.audioisexperimental=!0,a.audioissinglechannel=!0},ipod:function(a){a.audiocompatmode=2,a.audioteam=1,a.audioisexperimental=!0,a.audioissinglechannel=!0},ipad:function(a){a.audiocompatmode=2,a.audioteam=1,a.audioisexperimental=!0,a.audioissinglechannel=!0},nintendo_wii:function(a){a.iswii=!0,a.height=window.innerHeight,a.doublebuffering=!0}},AkihabaraShmup={NOOP:function(){},PUSH_NONE:0,PUSH_LEFT:1,PUSH_RIGHT:2,PUSH_UP:3,PUSH_DOWN:4,initialize:function(a,b){Akihabara.extendsFrom(Akihabara.extendsFrom({x:0,y:0,accx:0,accy:0,frames:{},maxacc:5,controlmaxacc:5,responsive:0,bounds:{x:0,y:0,w:AkihabaraGamebox.getScreenW(),h:AkihabaraGamebox.getScreenH()},weapon:0,hittime:5,camera:!1,flipv:!1,fliph:!1,health:1,tolerance:4},b),a),AkihabaraShmup.spawn(a)},spawn:function(a,b){a.xpushing=AkihabaraShmup.PUSH_NONE,a.vpushing=AkihabaraShmup.PUSH_NONE,a.counter=0,a.hittimer=0,a.killed=!1,Akihabara.copyModel(a,b)},getNextX:function(a){return a.x+AkihabaraHelpers.limit(a.accx,-a.maxacc,a.maxacc)},getNextY:function(a){return a.y+AkihabaraHelpers.limit(a.accy,-a.maxacc,a.maxacc)},controlKeys:function(a,b){AkihabaraGamebox.keyIsPressed(b.left)?(a.xpushing=AkihabaraShmup.PUSH_LEFT,a.accx>a.responsive&&(a.accx=a.responsive),a.accx=AkihabaraHelpers.limit(a.accx-1,-a.controlmaxacc,a.controlmaxacc)):AkihabaraGamebox.keyIsPressed(b.right)?(a.xpushing=AkihabaraShmup.PUSH_RIGHT,a.accx<-a.responsive&&(a.accx=-a.responsive),a.accx=AkihabaraHelpers.limit(a.accx+1,-a.controlmaxacc,a.controlmaxacc)):a.xpushing=AkihabaraShmup.PUSH_NONE,AkihabaraGamebox.keyIsPressed(b.up)?(a.ypushing=AkihabaraShmup.PUSH_UP,a.accy>a.responsive&&(a.accy=a.responsive),a.accy=AkihabaraHelpers.limit(a.accy-1,-a.controlmaxacc,a.controlmaxacc)):AkihabaraGamebox.keyIsPressed(b.down)?(a.ypushing=AkihabaraShmup.PUSH_DOWN,a.accy<-a.responsive&&(a.accy=-a.responsive),a.accy=AkihabaraHelpers.limit(a.accy+1,-a.controlmaxacc,a.controlmaxacc)):a.ypushing=AkihabaraShmup.PUSH_NONE},applyForces:function(a){a.x=AkihabaraShmup.getNextX(a),a.y=AkihabaraShmup.getNextY(a)},handleAccellerations:function(a){a.xpushing||(a.accx=AkihabaraHelpers.goToZero(a.accx)),a.ypushing||(a.accy=AkihabaraHelpers.goToZero(a.accy))},keepInBounds:function(a){a.x<a.bounds.x?(a.x=a.bounds.x,a.accx=0):a.x+a.w>a.bounds.x+a.bounds.w&&(a.x=a.bounds.x+a.bounds.w-a.w,a.accx=0),a.y<a.bounds.y?(a.y=a.bounds.y,a.accy=0):a.y+a.h>a.bounds.y+a.bounds.h&&(a.y=a.bounds.y+a.bounds.h-a.h,a.accy=0)},setFrame:function(a){a.hittimer&&a.hittimer--,a.frame=AkihabaraGamebox.decideFrame(a.counter,a.hittimer?a.frames.hit:a.frames.still)},fireBullet:function(a,b,c){var d=AkihabaraGamebox.getTiles(c.tileset),e=AkihabaraGamebox.addObject(Akihabara.extendsFrom({_bullet:!0,fliph:!1,flipv:!1,id:b,group:a,cnt:0,tileset:"",frames:{},acc:0,angle:0,camera:!1,accx:null==c.accx?Math.floor(AkihabaraTrigo.translateX(0,c.angle,c.acc)):0,accy:null==c.accy?Math.floor(AkihabaraTrigo.translateY(0,c.angle,c.acc)):0,x:c.from.x+c.from.hw-d.tilehw+(c.gapx?c.gapx:0),y:c.upper?c.from.y-d.tilehh+(c.gapy?c.gapy:0):c.from.y+c.from.h-d.tilehh-(c.gapy?c.gapy:0),collidegroup:"",spark:AkihabaraShmup.NOOP,power:1},c));return e[null==c.logicon?"first":c.logicon]=function(){if(this.x+=this.accx,this.y+=this.accy,this.cnt=(this.cnt+1)%10,AkihabaraGamebox.objectIsVisible(this)){if(null!=this.collidegroup)for(var a in AkihabaraGamebox._objects[this.collidegroup])!AkihabaraGamebox._objects[this.collidegroup][a].initialize&&AkihabaraGamebox.collides(this,AkihabaraGamebox._objects[this.collidegroup][a],AkihabaraGamebox._objects[this.collidegroup][a].tolerance)&&null!=AkihabaraGamebox._objects[this.collidegroup][a].hitByBullet&&(AkihabaraGamebox._objects[this.collidegroup][a].hitByBullet(this)||(this.spark(this),AkihabaraGamebox.trashObject(this)))}else AkihabaraGamebox.trashObject(this)},e[null==c.bliton?"blit":c.bliton]=function(){AkihabaraGamebox.blitTile(AkihabaraGamebox.getBufferContext(),{tileset:this.tileset,tile:AkihabaraGamebox.decideFrame(this.cnt,this.frames),dx:this.x,dy:this.y,camera:this.camera,fliph:this.side,flipv:this.flipv})},e},hitByBullet:function(a,b){b.power&&(a.health-=b.power,a.health<=0?a.kill(b):a.hittimer=a.hittime)},generateEnemy:function(a,b,c,d){Akihabara.extendsFrom(d,c);
var e=AkihabaraGamebox.addObject(Akihabara.extendsFrom({id:b,group:a,cnt:0,tileset:"",frames:{},acc:0,angle:0,camera:!1,fliph:!1,flipv:!1,accx:null==c.accx?Math.floor(AkihabaraTrigo.translateX(0,c.angle,c.acc)):0,accy:null==c.accy?Math.floor(AkihabaraTrigo.translateY(0,c.angle,c.acc)):0,x:c.x,y:c.y,animationset:"still",defaultanimationset:"still",hitanimationset:"still",hittime:5,script:AkihabaraShmup.NOOP,handler:AkihabaraShmup.NOOP,scriptline:null==c.scriptline?-1:c.scriptline-1,newline:!0,waitframes:0,doframes:0,mode:0,line:{},dohandler:null,ended:!1,health:1,hittimer:0,kill:AkihabaraShmup.NOOP,tolerance:0,initialize:null,invulnerable:!1,hitAnimation:function(a){this.hittimer=null==a?this.hittime:a,this.animationset=this.hitanimationset},goTo:function(a){this.waitframes=0,this.doframes=0,this.line={},this.scriptline=a-1},hitByBullet:function(a){!this.invulnerable&&a.power&&(this.health-=a.power,this.health<=0?this.kill(this,a):this.hitAnimation())}},c));return e[null==c.logicon?"first":c.logicon]=function(){null!=this.initialize&&(this.initialize(this),this.initialize=null),this.ended||(this.waitframes||this.doframes||null!=this.line.waitfor&&!this.line.waitfor(this)||(this.scriptline++,this.everycnt=-1,null==this.script[this.scriptline]?this.ended=!0:(null!=this.script[this.scriptline]["goto"]&&(this.scriptline=this.script[this.scriptline]["goto"]),this.line=this.script[this.scriptline],null!=this.line.afterframes&&(this.waitframes=this.line.afterframes),this.doframes=null!=this.line.forframes?this.line.forframes:1,this.line.cleardo?this.dohandler=null:null!=this.line.doit&&(this.dohandler={actiontimes:0,timer:"keep"===this.line.doit.every?this.dohandler.every:this.line.doit.every,every:"keep"===this.line.doit.every?this.dohandler.every:this.line.doit.every,once:"keep"===this.line.doit.once?this.dohandler.once:this.line.doit.once,action:"keep"===this.line.doit.action?this.dohandler.action:this.line.doit.action,render:"keep"===this.line.doit.render?this.dohandler.render:this.line.doit.render}))),this.waitframes||!this.doframes||this.ended||(this.doframes--,null!=this.line.setinvulnerable&&(this.invulnerable=this.line.setinvulnerable),null!=this.line.setx&&(this.x=this.line.setx),null!=this.line.sety&&(this.y=this.line.sety),null!=this.line.addx&&(this.x+=this.line.addx),null!=this.line.addy&&(this.y+=this.line.addy),null!=this.line.setaccx&&(this.accx=this.line.setaccx),null!=this.line.setaccy&&(this.accy=this.line.setaccy),null!=this.line.setacc&&(this.acc=this.line.setacc,this.accx=Math.floor(AkihabaraTrigo.translateX(0,this.angle,this.acc)),this.accy=Math.floor(AkihabaraTrigo.translateY(0,this.angle,this.acc))),null!=this.line.addaccx&&(this.accx+=this.line.addaccx),null!=this.line.addaccy&&(this.accy+=this.line.addaccy),null!=this.line.addacc&&(this.acc+=this.line.addacc,this.accx=Math.floor(AkihabaraTrigo.translateX(0,this.angle,this.acc)),this.accy=Math.floor(AkihabaraTrigo.translateY(0,this.angle,this.acc))),null!=this.line.setangle&&(this.angle=this.line.setangle,this.accx=Math.floor(AkihabaraTrigo.translateX(0,this.angle,this.acc)),this.accy=Math.floor(AkihabaraTrigo.translateY(0,this.angle,this.acc))),null!=this.line.addangle&&(this.angle+=this.line.addangle,this.accx=Math.floor(AkihabaraTrigo.translateX(0,this.angle,this.acc)),this.accy=Math.floor(AkihabaraTrigo.translateY(0,this.angle,this.acc))),this.line.everyframe&&(this.waitframes=this.line.everyframe)),this.waitframes>0&&this.waitframes--),this.dohandler&&null!=this.dohandler.action&&(this.dohandler.timer===this.dohandler.every?(this.dohandler.action(this,this.dohandler.actiontimes),this.dohandler.timer=0,this.dohandler.actiontimes++):this.dohandler.once||this.dohandler.timer++),null!=this.handler&&this.handler(this),this.hittimer&&(this.hittimer--,this.hittimer||(this.animationset=this.defaultanimationset)),this.x+=this.accx,this.y+=this.accy,this.cnt=(this.cnt+1)%10},e[null==c.bliton?"blit":c.bliton]=function(){AkihabaraGamebox.blitTile(AkihabaraGamebox.getBufferContext(),{tileset:this.tileset,tile:AkihabaraGamebox.decideFrame(this.cnt,this.frames[this.animationset]),dx:this.x,dy:this.y,camera:this.camera,fliph:this.side,flipv:this.flipv}),this.dohandler&&null!=this.dohandler.render&&this.dohandler.render(this)},e},generateScroller:function(a,b,c){var d={id:b,group:a,y:0,x:0,stage:{},speed:0,stop:null,block:-1,bly:0,lblock:-1,lbly:0,lget:0,tbly:0,trb:0,maxwidth:0,loopstart:null,loopend:null,looprounds:0,panspeed:1,panstimer:0,destspeed:0,setLoop:function(a,b){this.loopstart=a,this.loopend=b,this.lget=1,this.looprounds=1},quitLoop:function(){this.setLoop(null,null),this.looprounds=0},setSpeed:function(a){this.speed=a,this.destspeed=a},panToSpeed:function(a,b){this.destspeed=a,this.panspeed=b},quitStop:function(){this.stop=null},setStop:function(a){this.stop=a},setX:function(a){this.x=0>a?0:a+AkihabaraGamebox.getScreenW()>this.maxwidth?this.maxwidth-AkihabaraGamebox.getScreenW():a}},e=AkihabaraGamebox.addObject(Akihabara.extendsFrom(AkihabaraHelpers.cloneObject(c),d));return e[null==c.logicon?"first":c.logicon]=function(){(null==this.stop||this.y<this.stop)&&(this.speed!==this.destspeed&&(this.panstimer?this.panstimer--:(this.speed<this.destspeed?this.speed++:this.speed>this.destspeed&&this.speed--,this.panstimer=this.panspeed)),this.y+=this.speed,null!=this.stop&&this.y>=this.stop&&(this.y=this.stop),null!=this.loopend&&this.y>this.loopend&&(this.y=this.loopstart+(this.y-this.loopend),this.looprounds++,1===this.lget?(this.block=0,this.bly=0,this.lget=2):(this.block=this.lblock,this.bly=this.lbly))),this.trb=this.block,this.tbly=this.bly;do this.trb++,this.tbly+=AkihabaraGamebox.getImage(this.stage[this.trb].image).height;while(this.tbly<this.y);this.block=this.trb-1,this.bly=this.tbly-AkihabaraGamebox.getImage(this.stage[this.trb].image).height,2===this.lget&&(this.lblock=this.block,this.lbly=this.bly,this.lget=3)},e[null==c.bliton?"blit":c.bliton]=function(){var a=this.tbly-this.y,b=!1;do a>AkihabaraGamebox.getScreenH()&&(b=!0),AkihabaraGamebox.blitAll(AkihabaraGamebox.getBufferContext(),AkihabaraGamebox.getImage(this.stage[this.trb].image),{dx:-this.x,dy:AkihabaraGamebox.getScreenH()-a}),this.trb++,a+=AkihabaraGamebox.getImage(this.stage[this.trb].image).height;while(!b)},e}};